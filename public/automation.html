<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automa√ß√£o - Star Tickets</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .automation-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .option-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .option-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .option-card.active {
            border: 3px solid var(--primary-color);
            background: #f0f7ff;
        }

        .option-icon {
            font-size: 3rem;
            min-width: 60px;
            text-align: center;
        }

        .option-content {
            flex: 1;
        }

        .option-content h3 {
            margin: 0 0 5px 0;
            color: var(--primary-color);
        }

        .option-content p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .current-badge {
            background: var(--accent-color);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #eee;
        }

        .btn-large {
            flex: 1;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-cancel:hover {
            background: #5a6268;
        }

        .establishment-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 2px solid #ddd;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .establishment-card:hover {
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .establishment-card.selected {
            border-color: var(--accent-color);
            background: #fff3cd;
        }

        .establishment-name {
            font-weight: bold;
            color: var(--primary-color);
        }

        .selected-badge {
            background: var(--accent-color);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
        }
    </style>
</head>

<body>
    <header>
        <h1>ü§ñ Automa√ß√£o de Inicializa√ß√£o</h1>
        <p>Configure qual p√°gina deve abrir automaticamente ao acessar o sistema</p>
    </header>

    <div class="container automation-container">
        <div class="card">
            <h2 style="margin-top: 0;">Selecione a P√°gina de Inicializa√ß√£o</h2>
            <p style="color: #666; margin-bottom: 30px;">
                Ideal para computadores fixos: TVs, esta√ß√µes de recep√ß√£o e salas de atendimento
            </p>

            <div class="option-card" onclick="selectOption('none')">
                <div class="option-icon">üè†</div>
                <div class="option-content">
                    <h3>Nenhuma (Padr√£o)</h3>
                    <p>Sempre mostrar o menu principal ao abrir o sistema</p>
                </div>
                <div class="status" id="status-none"></div>
            </div>

            <div class="option-card" onclick="selectOption('totem.html')">
                <div class="option-icon">üé´</div>
                <div class="option-content">
                    <h3>Totem de Autoatendimento</h3>
                    <p>Para totens de retirada de senha pelos clientes</p>
                </div>
                <div class="status" id="status-totem"></div>
            </div>

            <div class="option-card" onclick="selectOption('reception.html')">
                <div class="option-icon">üë•</div>
                <div class="option-content">
                    <h3>Recep√ß√£o</h3>
                    <p>Para computadores das atendentes da recep√ß√£o</p>
                </div>
                <div class="status" id="status-reception"></div>
            </div>

            <div class="option-card" onclick="selectOption('professional.html')">
                <div class="option-icon">üè•</div>
                <div class="option-content">
                    <h3>Esta√ß√£o do Profissional</h3>
                    <p>Para computadores dos profissionais nas salas</p>
                </div>
                <div class="status" id="status-professional"></div>
            </div>

            <div class="option-card" onclick="selectOption('tv.html')">
                <div class="option-icon">üì∫</div>
                <div class="option-content">
                    <h3>Painel de TV</h3>
                    <p>Para televis√µes que exibem as chamadas</p>
                </div>
                <div class="status" id="status-tv"></div>
            </div>

            <!-- TV Location Selection (shown only when TV is selected) -->
            <div id="tv-location-section"
                style="display: none; margin-top: 20px; padding: 20px; background: #f0f7ff; border-radius: 8px; border: 2px solid var(--primary-color);">
                <h3 style="margin-top: 0; color: var(--primary-color);">üìç Selecione a Localiza√ß√£o da TV</h3>
                <p style="color: #666; margin-bottom: 15px;">Escolha qual estabelecimento esta TV ir√° exibir</p>

                <div id="establishments-list">
                    <div style="text-align: center; color: #999;">Carregando estabelecimentos...</div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-large" onclick="saveConfiguration()"
                    style="background: var(--primary-color); color: white;">
                    ‚úì Salvar Configura√ß√£o
                </button>
                <button class="btn-large btn-cancel" onclick="window.location.href='index.html'">
                    ‚úó Cancelar
                </button>
            </div>
        </div>

        <div class="card" style="margin-top: 20px; background: #fffbea; border-left: 4px solid #ffc107;">
            <h3 style="margin-top: 0; color: #856404;">‚ÑπÔ∏è Como Funciona</h3>
            <ul style="color: #856404; line-height: 1.8;">
                <li><strong>Esta configura√ß√£o fica salva neste navegador/computador</strong></li>
                <li>Ao acessar o sistema, ser√° redirecionado automaticamente para a p√°gina selecionada</li>
                <li>Para acessar outras p√°ginas, digite o endere√ßo direto ou configure "Nenhuma"</li>
                <li>Ideal para computadores/TVs dedicados a uma fun√ß√£o espec√≠fica</li>
            </ul>
        </div>
    </div>

    <script>
        let selectedOption = 'none';
        let selectedEstablishment = null;
        let establishments = [];

        async function loadEstablishments() {
            try {
                const res = await fetch('/api/admin/establishments');
                establishments = await res.json();
                renderEstablishments();
            } catch (e) {
                console.error('Error loading establishments:', e);
            }
        }

        function renderEstablishments() {
            const container = document.getElementById('establishments-list');
            container.innerHTML = '';

            establishments.forEach(est => {
                const card = document.createElement('div');
                card.className = 'establishment-card';
                card.onclick = () => selectEstablishment(est.id);
                card.innerHTML = `
                    <div class="establishment-name">${est.name}</div>
                    <div class="status" id="est-status-${est.id}"></div>
                `;
                container.appendChild(card);
            });
        }

        function selectEstablishment(estId) {
            selectedEstablishment = estId;

            // Update UI
            document.querySelectorAll('.establishment-card').forEach(card => {
                card.classList.remove('selected');
            });

            document.querySelectorAll('[id^="est-status-"]').forEach(status => {
                status.innerHTML = '';
            });

            const selectedCard = document.querySelector(`[onclick*="selectEstablishment(${estId})"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            const statusEl = document.getElementById(`est-status-${estId}`);
            if (statusEl) {
                statusEl.innerHTML = '<span class="selected-badge">‚úì SELECIONADA</span>';
            }
        }

        function loadCurrentConfiguration() {
            const current = localStorage.getItem('star_tickets_auto_redirect') || 'none';
            selectedOption = current;

            // Load TV establishment if configured
            if (current === 'tv.html') {
                const tvEst = localStorage.getItem('star_tickets_tv_establishment');
                if (tvEst) {
                    selectedEstablishment = parseInt(tvEst);
                }
            }

            updateUI();
        }

        async function selectOption(option) {
            selectedOption = option;

            if (option === 'tv.html') {
                // Show TV location section
                document.getElementById('tv-location-section').style.display = 'block';

                // Load establishments if not loaded yet
                if (establishments.length === 0) {
                    await loadEstablishments();
                }

                // Select previously configured establishment if exists
                if (selectedEstablishment) {
                    selectEstablishment(selectedEstablishment);
                }
            } else {
                // Hide TV location section for other options
                document.getElementById('tv-location-section').style.display = 'none';
                selectedEstablishment = null;
            }

            updateUI();
        }

        function updateUI() {
            // Remove all active states
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('active');
            });

            // Clear all status badges
            document.querySelectorAll('.status').forEach(status => {
                status.innerHTML = '';
            });

            // Set active state
            const key = selectedOption === 'none' ? 'none' : selectedOption.replace('.html', '');
            const activeCard = document.querySelector(`[onclick="selectOption('${selectedOption}')"]`);
            if (activeCard) {
                activeCard.classList.add('active');
            }

            // Show current badge
            const statusEl = document.getElementById(`status-${key}`);
            if (statusEl) {
                statusEl.innerHTML = '<span class="current-badge">SELECIONADO</span>';
            }
        }

        function saveConfiguration() {
            // Validate TV selection
            if (selectedOption === 'tv.html' && !selectedEstablishment) {
                alert('‚ö†Ô∏è Por favor, selecione a localiza√ß√£o da TV antes de salvar.');
                return;
            }

            localStorage.setItem('star_tickets_auto_redirect', selectedOption);

            // Save TV establishment if TV is selected
            if (selectedOption === 'tv.html') {
                localStorage.setItem('star_tickets_tv_establishment', selectedEstablishment);
            } else {
                localStorage.removeItem('star_tickets_tv_establishment');
            }

            if (selectedOption === 'none') {
                alert('‚úÖ Configura√ß√£o salva! O sistema abrir√° no menu principal.');
                window.location.href = 'index.html';
            } else {
                let message = `‚úÖ Configura√ß√£o salva!\n\nAo acessar o sistema, voc√™ ser√° redirecionado para "${getPageName(selectedOption)}".`;

                if (selectedOption === 'tv.html') {
                    const estName = establishments.find(e => e.id === selectedEstablishment)?.name;
                    message += `\nTV configurada para: ${estName}`;
                }

                if (confirm(message + '\n\nDeseja testar agora?')) {
                    window.location.href = selectedOption;
                } else {
                    window.location.href = 'index.html';
                }
            }
        }

        function getPageName(page) {
            const names = {
                'totem.html': 'Totem',
                'reception.html': 'Recep√ß√£o',
                'professional.html': 'Profissional',
                'tv.html': 'Painel de TV'
            };
            return names[page] || page;
        }

        // Initialize
        loadCurrentConfiguration();
    </script>
</body>

</html>