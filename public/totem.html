<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Tickets - Autoatendimento</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .priority-selection {
            padding: 40px 20px;
        }

        .priority-btn {
            background: white;
            border: 3px solid #ddd;
            border-radius: 15px;
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .priority-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .normal-btn {
            border-color: #2196F3;
        }

        .normal-btn:hover {
            background: #2196F3;
            color: white;
        }

        .priority-btn-special {
            border-color: #FF9800;
            background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
        }

        .priority-btn-special:hover {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            border-color: #F57C00;
        }

        .priority-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .priority-label {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .priority-subtitle {
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
        }

        .priority-btn-special:hover .priority-subtitle {
            color: white;
        }
    </style>
</head>

<body>
    <header>
        <h1>Bem-vindo ao Star Tickets</h1>
        <p>Toque para selecionar seu atendimento</p>
    </header>

    <div class="container">
        <!-- Priority Selection Screen (First Screen) -->
        <div id="priority-selection" class="priority-selection">
            <h2 style="text-align:center; margin-bottom:40px;">Selecione o tipo de atendimento</h2>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:30px; max-width:800px; margin:0 auto;">
                <button class="priority-btn normal-btn" onclick="selectPriority(false)">
                    <div class="priority-icon">üë§</div>
                    <div class="priority-label">ATENDIMENTO<br>NORMAL</div>
                </button>
                <button class="priority-btn priority-btn-special" onclick="selectPriority(true)">
                    <div class="priority-icon">‚≠ê</div>
                    <div class="priority-label">ATENDIMENTO<br>PREFERENCIAL</div>
                    <div class="priority-subtitle">Idosos, Gestantes,<br>Lactantes, PcD</div>
                </button>
            </div>
        </div>

        <!-- Menu Container (Hidden initially) -->
        <div id="menu-container" class="menu-grid" style="display:none;">
            <!-- Menus will be loaded here -->
        </div>

        <div id="selection-summary" class="card" style="display:none; margin-top: 20px;">
            <h3>Servi√ßos Selecionados:</h3>
            <ul id="selected-list"></ul>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button id="back-to-menu-btn" class="btn btn-large" onclick="backToMenu()" style="flex:1;">
                    ‚¨ÖÔ∏è VOLTAR E ADICIONAR OUTROS SERVI√áOS
                </button>
                <button class="btn btn-large btn-accent" onclick="confirmTicket()" style="flex:1;">
                    CONFIRMAR E IMPRIMIR
                </button>
            </div>
            <button class="btn" onclick="resetSelection()" style="width:100%;">Limpar Tudo</button>
        </div>
    </div>

    <!-- Modal Confirma√ß√£o -->
    <div id="confirmation-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:white; flex-direction:column; justify-content:center; align-items:center; z-index:1000;">
        <div
            style="background:white; color:black; padding:40px; border-radius:10px; text-align:center; margin:20px; max-width:600px;">
            <h2>Confirme seus servi√ßos</h2>
            <div id="confirmation-services" style="text-align:left; margin:20px 0;"></div>
            <div id="confirmation-total"
                style="font-size:1.5rem; font-weight:bold; margin:20px 0; padding:20px; background:#f0f0f0; border-radius:5px;">
            </div>
            <button class="btn btn-large btn-accent" onclick="finalConfirm()">CONFIRMAR E IMPRIMIR</button>
            <button class="btn" onclick="closeConfirmation()">CANCELAR</button>
        </div>
    </div>

    <!-- Modal Impress√£o -->
    <div id="print-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:white; flex-direction:column; justify-content:center; align-items:center; z-index:1000;">
        <div
            style="background:white; color:black; padding:50px; border-radius:15px; text-align:center; margin:20px; max-width:500px;">
            <h2 style="color:#4CAF50; margin-top:0;">‚úì Senha Gerada com Sucesso!</h2>
            <h1 id="modal-ticket-code" style="font-size:5rem; margin:20px 0; color:var(--primary-color);">---</h1>
            <p style="font-size:1.2rem; margin:20px 0;">Aguarde ser chamado no painel.</p>

            <div style="border-top:2px dashed #ddd; margin:30px 0; padding-top:30px;">
                <p style="font-size:1rem; color:#666; margin-bottom:15px;">
                    üì± <strong>Acompanhe pelo celular!</strong><br>
                    Escaneie o QR Code abaixo:
                </p>
                <div id="qr-code-container" style="display:flex; justify-content:center; margin:20px 0;">
                    <img id="qr-code-image" src="" alt="QR Code"
                        style="max-width:200px; border:3px solid #eee; border-radius:10px; padding:10px; display:none;">
                </div>
            </div>

            <button class="btn btn-large btn-accent" onclick="window.location.reload()"
                style="margin-top:20px; width:100%;">
                FINALIZAR ATENDIMENTO
            </button>
        </div>
    </div>
    </div>

    <script>
        let currentMenuId = null;
        let selectedServices = [];
        let menuData = [];
        let menuHistory = []; // Track navigation history
        let isPriorityTicket = false; // Track if user selected priority

        function selectPriority(priority) {
            isPriorityTicket = priority;
            // Hide priority selection
            document.getElementById('priority-selection').style.display = 'none';
            // Show menu container
            document.getElementById('menu-container').style.display = 'grid';
            // Load menu
            loadConfig();
        }

        async function loadConfig() {
            const res = await fetch('/api/config');
            menuData = await res.json();
            renderMenu(menuData);
        }

        function renderMenu(items) {
            const container = document.getElementById('menu-container');
            container.innerHTML = '';

            // Back button if not root
            if (currentMenuId) {
                const backBtn = document.createElement('div');
                backBtn.className = 'menu-item';
                backBtn.innerText = '‚¨ÖÔ∏è Voltar';
                backBtn.onclick = () => {
                    // Go back in history
                    menuHistory.pop();
                    const previous = menuHistory[menuHistory.length - 1];
                    if (previous) {
                        currentMenuId = previous.id;
                        renderMenu(previous.children);
                    } else {
                        currentMenuId = null;
                        renderMenu(menuData);
                    }
                };
                container.appendChild(backBtn);
            }

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'menu-item';

                // Check if this service is already selected
                const isSelected = selectedServices.some(s => s.service_id === item.service_id && item.service_id);
                if (isSelected) {
                    div.classList.add('selected');
                }

                // Show wait time for services
                const waitTimeText = item.service_id && item.estimated_wait_minutes ?
                    `<small style="display:block; color:#666; margin-top:5px;">‚è±Ô∏è Tempo estimado: ${item.estimated_wait_minutes} min</small>` : '';

                div.innerHTML = `<div>${item.icon ? '' : ''} ${item.label}${waitTimeText}</div>`;

                div.onclick = () => {
                    if (item.children && item.children.length > 0) {
                        currentMenuId = item.id;
                        menuHistory.push(item);
                        renderMenu(item.children);
                    } else {
                        // It's a service
                        toggleService(item, div);
                    }
                };
                container.appendChild(div);
            });
        }

        function toggleService(item, divElement) {
            if (!item.service_id) return;

            // Check if already selected
            const existingIndex = selectedServices.findIndex(s => s.service_id === item.service_id);

            if (existingIndex >= 0) {
                // Remove if already selected
                selectedServices.splice(existingIndex, 1);
                divElement.classList.remove('selected');
            } else {
                // Add to selection
                selectedServices.push(item);
                divElement.classList.add('selected');
            }

            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('selection-summary');
            const list = document.getElementById('selected-list');
            const backBtn = document.getElementById('back-to-menu-btn');

            if (selectedServices.length > 0) {
                summary.style.display = 'block';
                backBtn.style.display = 'inline-block'; // Show back button

                // Calculate total estimated time
                const totalTime = selectedServices.reduce((sum, s) => sum + (s.estimated_wait_minutes || 0), 0);

                list.innerHTML = selectedServices.map(s =>
                    `<li>${s.label} <small style="color:#666;">(~${s.estimated_wait_minutes || 0} min)</small></li>`
                ).join('');

                // Add total time display
                if (totalTime > 0) {
                    list.innerHTML += `<li style="margin-top:10px; padding-top:10px; border-top:2px solid #ddd; font-weight:bold;">
                        ‚è±Ô∏è Tempo total estimado: ${totalTime} minutos
                    </li>`;
                }
            } else {
                summary.style.display = 'none';
            }
        }

        function resetSelection() {
            selectedServices = [];
            updateSummary();
            currentMenuId = null;
            menuHistory = [];
            renderMenu(menuData);
        }

        function backToMenu() {
            // Hide only the back button, keep summary visible
            document.getElementById('back-to-menu-btn').style.display = 'none';
            // Go back to root menu
            currentMenuId = null;
            menuHistory = [];
            renderMenu(menuData);
        }

        async function confirmTicket() {
            if (selectedServices.length === 0) return;

            // Show confirmation modal
            const totalTime = selectedServices.reduce((sum, s) => sum + (s.estimated_wait_minutes || 0), 0);


            const servicesHtml = selectedServices.map(s =>
                `<div style="padding:10px; margin:5px 0; background:#f9f9f9; border-radius:5px;">
                    <strong>${s.label}</strong>
                    <span style="float:right; color:#666;">~${s.estimated_wait_minutes || 0} min</span>
                </div>`
            ).join('');

            document.getElementById('confirmation-services').innerHTML = servicesHtml;
            document.getElementById('confirmation-total').innerHTML =
                `‚è±Ô∏è Tempo total estimado: <span style="color:var(--accent-color);">${totalTime} minutos</span>`;
            document.getElementById('confirmation-modal').style.display = 'flex';
        }

        function closeConfirmation() {
            document.getElementById('confirmation-modal').style.display = 'none';
        }

        async function finalConfirm() {
            // Hide confirmation modal
            document.getElementById('confirmation-modal').style.display = 'none';

            const serviceIds = selectedServices.map(s => s.service_id);

            try {
                const res = await fetch('/api/tickets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serviceIds, isPriority: isPriorityTicket })
                });
                const data = await res.json();

                showPrintModal(data.displayCode, data.ticketId);
            } catch (e) {
                showToast('Erro ao gerar senha', 'error');
            }
        }

        async function showPrintModal(code, ticketId) {
            document.getElementById('modal-ticket-code').innerText = code;
            document.getElementById('print-modal').style.display = 'flex';

            // Load QR code
            try {
                const qrRes = await fetch(`/api/qrcode/${ticketId}`);
                const qrData = await qrRes.json();
                const qrImage = document.getElementById('qr-code-image');
                qrImage.src = qrData.qrCode;
                qrImage.style.display = 'block';
            } catch (e) {
                console.error('Erro ao carregar QR code:', e);
            }
        }

        function closeModal() {
            document.getElementById('print-modal').style.display = 'none';
            // Reset everything and go back to main menu
            resetSelection();
        }

        loadConfig();
    </script>
    <script src="js/common/trace.js"></script>
    <script src="js/common/toast.js"></script>
</body>

</html>