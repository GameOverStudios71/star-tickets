<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Tickets - Autoatendimento</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <h1>Bem-vindo ao Star Tickets</h1>
        <p>Toque para selecionar seu atendimento</p>
    </header>

    <div class="container">
        <div id="menu-container" class="menu-grid">
            <!-- Menus will be loaded here -->
        </div>

        <div id="selection-summary" class="card" style="display:none; margin-top: 20px;">
            <h3>Serviços Selecionados:</h3>
            <ul id="selected-list"></ul>
            <button id="back-to-menu-btn" class="btn btn-large" onclick="backToMenu()">⬅️ VOLTAR E ADICIONAR OUTROS
                SERVIÇOS</button>
            <button class="btn btn-large btn-accent" onclick="confirmTicket()">CONFIRMAR E IMPRIMIR</button>
            <button class="btn" onclick="resetSelection()">Limpar Tudo</button>
        </div>
    </div>

    <!-- Modal Confirmação -->
    <div id="confirmation-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:white; flex-direction:column; justify-content:center; align-items:center; z-index:1000;">
        <div
            style="background:white; color:black; padding:40px; border-radius:10px; text-align:center; margin:20px; max-width:600px;">
            <h2>Confirme seus serviços</h2>
            <div id="confirmation-services" style="text-align:left; margin:20px 0;"></div>
            <div id="confirmation-total"
                style="font-size:1.5rem; font-weight:bold; margin:20px 0; padding:20px; background:#f0f0f0; border-radius:5px;">
            </div>
            <button class="btn btn-large btn-accent" onclick="finalConfirm()">CONFIRMAR E IMPRIMIR</button>
            <button class="btn" onclick="closeConfirmation()">CANCELAR</button>
        </div>
    </div>

    <!-- Modal Impressão -->
    <div id="print-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:white; flex-direction:column; justify-content:center; align-items:center; z-index:1000;">
        <h2>Sua Senha</h2>
        <div style="background:white; color:black; padding:40px; border-radius:10px; text-align:center; margin:20px;">
            <h1 id="modal-ticket-code" style="font-size:5rem; margin:0;">---</h1>
            <p>Aguarde ser chamado no painel.</p>
            <div id="qr-code-container" style="margin:20px 0;">
                <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">Escaneie para acompanhar:</p>
                <img id="qr-code-image" src="" alt="QR Code" style="max-width:200px; display:none;">
            </div>
            <p id="auto-close-message" style="color:#666; margin-top:20px;">Voltando ao menu em <span
                    id="countdown">5</span> segundos...</p>
        </div>
    </div>
    </div>

    <script>
        let currentMenuId = null;
        let selectedServices = [];
        let menuData = [];
        let menuHistory = []; // Track navigation history

        async function loadConfig() {
            const res = await fetch('/api/config');
            menuData = await res.json();
            renderMenu(menuData);
        }

        function renderMenu(items) {
            const container = document.getElementById('menu-container');
            container.innerHTML = '';

            // Back button if not root
            if (currentMenuId) {
                const backBtn = document.createElement('div');
                backBtn.className = 'menu-item';
                backBtn.innerText = '⬅️ Voltar';
                backBtn.onclick = () => {
                    // Go back in history
                    menuHistory.pop();
                    const previous = menuHistory[menuHistory.length - 1];
                    if (previous) {
                        currentMenuId = previous.id;
                        renderMenu(previous.children);
                    } else {
                        currentMenuId = null;
                        renderMenu(menuData);
                    }
                };
                container.appendChild(backBtn);
            }

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'menu-item';

                // Check if this service is already selected
                const isSelected = selectedServices.some(s => s.service_id === item.service_id && item.service_id);
                if (isSelected) {
                    div.classList.add('selected');
                }

                // Show wait time for services
                const waitTimeText = item.service_id && item.estimated_wait_minutes ?
                    `<small style="display:block; color:#666; margin-top:5px;">⏱️ Tempo estimado: ${item.estimated_wait_minutes} min</small>` : '';

                div.innerHTML = `<div>${item.icon ? '' : ''} ${item.label}${waitTimeText}</div>`;

                div.onclick = () => {
                    if (item.children && item.children.length > 0) {
                        currentMenuId = item.id;
                        menuHistory.push(item);
                        renderMenu(item.children);
                    } else {
                        // It's a service
                        toggleService(item, div);
                    }
                };
                container.appendChild(div);
            });
        }

        function toggleService(item, divElement) {
            if (!item.service_id) return;

            // Check if already selected
            const existingIndex = selectedServices.findIndex(s => s.service_id === item.service_id);

            if (existingIndex >= 0) {
                // Remove if already selected
                selectedServices.splice(existingIndex, 1);
                divElement.classList.remove('selected');
            } else {
                // Add to selection
                selectedServices.push(item);
                divElement.classList.add('selected');
            }

            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('selection-summary');
            const list = document.getElementById('selected-list');
            const backBtn = document.getElementById('back-to-menu-btn');

            if (selectedServices.length > 0) {
                summary.style.display = 'block';
                backBtn.style.display = 'inline-block'; // Show back button

                // Calculate total estimated time
                const totalTime = selectedServices.reduce((sum, s) => sum + (s.estimated_wait_minutes || 0), 0);

                list.innerHTML = selectedServices.map(s =>
                    `<li>${s.label} <small style="color:#666;">(~${s.estimated_wait_minutes || 0} min)</small></li>`
                ).join('');

                // Add total time display
                if (totalTime > 0) {
                    list.innerHTML += `<li style="margin-top:10px; padding-top:10px; border-top:2px solid #ddd; font-weight:bold;">
                        ⏱️ Tempo total estimado: ${totalTime} minutos
                    </li>`;
                }
            } else {
                summary.style.display = 'none';
            }
        }

        function resetSelection() {
            selectedServices = [];
            updateSummary();
            currentMenuId = null;
            menuHistory = [];
            renderMenu(menuData);
        }

        function backToMenu() {
            // Hide only the back button, keep summary visible
            document.getElementById('back-to-menu-btn').style.display = 'none';
            // Go back to root menu
            currentMenuId = null;
            menuHistory = [];
            renderMenu(menuData);
        }

        async function confirmTicket() {
            if (selectedServices.length === 0) return;

            // Show confirmation modal
            const totalTime = selectedServices.reduce((sum, s) => sum + (s.estimated_wait_minutes || 0), 0);


            const servicesHtml = selectedServices.map(s =>
                `<div style="padding:10px; margin:5px 0; background:#f9f9f9; border-radius:5px;">
                    <strong>${s.label}</strong>
                    <span style="float:right; color:#666;">~${s.estimated_wait_minutes || 0} min</span>
                </div>`
            ).join('');

            document.getElementById('confirmation-services').innerHTML = servicesHtml;
            document.getElementById('confirmation-total').innerHTML =
                `⏱️ Tempo total estimado: <span style="color:var(--accent-color);">${totalTime} minutos</span>`;
            document.getElementById('confirmation-modal').style.display = 'flex';
        }

        function closeConfirmation() {
            document.getElementById('confirmation-modal').style.display = 'none';
        }

        async function finalConfirm() {
            // Hide confirmation modal
            document.getElementById('confirmation-modal').style.display = 'none';

            const serviceIds = selectedServices.map(s => s.service_id);

            try {
                const res = await fetch('/api/tickets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serviceIds })
                });
                const data = await res.json();

                showPrintModal(data.displayCode, data.ticketId);
            } catch (e) {
                showToast('Erro ao gerar senha', 'error');
            }
        }

        async function showPrintModal(code, ticketId) {
            document.getElementById('modal-ticket-code').innerText = code;
            document.getElementById('print-modal').style.display = 'flex';

            // Load QR code
            try {
                const qrRes = await fetch(`/api/qrcode/${ticketId}`);
                const qrData = await qrRes.json();
                const qrImage = document.getElementById('qr-code-image');
                qrImage.src = qrData.qrCode;
                qrImage.style.display = 'block';
            } catch (e) {
                console.error('Erro ao carregar QR code:', e);
            }

            // Start countdown
            let seconds = 5;
            const countdownEl = document.getElementById('countdown');

            const interval = setInterval(() => {
                seconds--;
                countdownEl.innerText = seconds;

                if (seconds <= 0) {
                    clearInterval(interval);
                    closeModal();
                }
            }, 1000);
        }

        function closeModal() {
            document.getElementById('print-modal').style.display = 'none';
            // Reset everything and go back to main menu
            resetSelection();
        }

        loadConfig();
    </script>
    <script src="js/common/trace.js"></script>
    <script src="js/common/toast.js"></script>
</body>

</html>