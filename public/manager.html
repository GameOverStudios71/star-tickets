<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Tickets - Gerente</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .room-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center;
        }

        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .room-count {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            border: none;
            background: none;
        }

        .ticket-item {
            background: #f9f9f9;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid var(--primary-color);
            cursor: pointer;
        }

        .ticket-item:hover {
            background: #f0f0f0;
        }

        .ticket-item.selected {
            background: #e3f2fd;
            border-left-color: #2196F3;
        }

        .optimization-panel {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            display: none;
        }

        .pending-service {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            border-radius: 4px;
        }

        .badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            background: #eee;
        }

        /* Relocation Mode Styles */
        .relocation-container {
            display: none;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 100px);
        }

        .relocation-col {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .relocation-col h3 {
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .list-container {
            flex: 1;
            overflow-y: auto;
        }

        .list-item {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .list-item:hover {
            background: #f5f5f5;
        }

        .list-item.active {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
        }

        .candidate-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .candidate-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
    </style>
</head>

<body>
    <header style="display:flex; justify-content:space-between; align-items:center; padding: 0 20px;">
        <h1>Gerenciamento de Filas</h1>
        <div>
            <button class="btn" onclick="openSoundModal()" style="margin-right: 10px; background: #9C27B0;">
                üîî Som da TV
            </button>
            <button id="tts-toggle-btn" class="btn" onclick="toggleTTS()"
                style="margin-right: 10px; background: #607D8B;">
                üîá Voz Desligada
            </button>
            <button id="toggle-mode-btn" class="btn" onclick="toggleRelocationMode()" style="margin-right: 10px;">
                üîÑ Modo Remanejamento
            </button>
            <a href="/" class="btn" style="background:transparent; border:1px solid white;">Voltar</a>
        </div>
    </header>

    <div class="container">
        <!-- Standard View -->
        <div id="rooms-grid" class="rooms-grid">
            <!-- Rooms will be loaded here -->
        </div>

        <!-- Relocation View -->
        <div id="relocation-view" class="relocation-container">
            <!-- Col 1: Target Rooms -->
            <div class="relocation-col">
                <h3>1. Sala de Destino</h3>
                <div id="target-rooms-list" class="list-container"></div>
            </div>

            <!-- Col 2: Candidates -->
            <div class="relocation-col">
                <h3>2. Candidatos (Aguardando em outros locais)</h3>
                <div
                    style="padding: 5px; background: #fff3e0; font-size: 0.9rem; margin-bottom: 10px; border-radius: 4px;">
                    Selecione quem voc√™ quer puxar para a sala selecionada.
                </div>
                <div style="margin-bottom: 10px;">
                    <label><input type="checkbox" onchange="toggleAllCandidates(this)"> Selecionar Todos</label>
                </div>
                <div id="candidates-list" class="list-container">
                    <p style="color:#999; text-align:center; margin-top:20px;">Selecione uma sala de destino</p>
                </div>
            </div>

            <!-- Col 3: Action -->
            <div class="relocation-col">
                <h3>3. A√ß√£o</h3>
                <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                    <div id="action-summary" style="text-align:center; margin-bottom:20px; font-size:1.2rem;">
                        Nenhum candidato selecionado
                    </div>
                    <button id="move-btn" class="btn btn-large" onclick="executeBulkMove()" disabled
                        style="width:100%; max-width:200px; opacity: 0.5;">
                        MOVER AGORA
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Queue Detail Modal -->
    <div id="queue-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">√ó</button>
            <h2 id="modal-title">Fila da Sala</h2>

            <div id="modal-ticket-list"></div>

            <div id="optimization-panel" class="optimization-panel">
                <h3>Otimiza√ß√£o de Fluxo</h3>
                <p>Senha: <strong id="opt-ticket-code"></strong></p>
                <p>Servi√ßos Pendentes:</p>
                <div id="opt-services-list"></div>
            </div>
        </div>
    </div>

    <!-- Sound Selection Modal -->
    <div id="sound-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="close-modal" onclick="closeSoundModal()">√ó</button>
            <h2>üîî Som da TV</h2>
            <p style="color: #666; margin-bottom: 20px;">Selecione o som de alerta para chamadas na TV:</p>

            <div id="sound-presets" style="display: flex; flex-direction: column; gap: 10px;">
                <label class="sound-option"
                    style="display: flex; align-items: center; padding: 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="sound" value="ding-dong"
                        style="margin-right: 15px; transform: scale(1.3);">
                    <div>
                        <strong>üéµ Ding Dong</strong>
                        <div style="font-size: 0.85rem; color: #666;">Som cl√°ssico de campainha</div>
                    </div>
                    <button onclick="previewSound('ding-dong'); event.stopPropagation();" class="btn"
                        style="margin-left: auto; padding: 5px 10px; font-size: 0.8rem;">‚ñ∂ Ouvir</button>
                </label>

                <label class="sound-option"
                    style="display: flex; align-items: center; padding: 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="sound" value="triple-beep"
                        style="margin-right: 15px; transform: scale(1.3);">
                    <div>
                        <strong>üì¢ Triple Beep</strong>
                        <div style="font-size: 0.85rem; color: #666;">Tr√™s bipes r√°pidos</div>
                    </div>
                    <button onclick="previewSound('triple-beep'); event.stopPropagation();" class="btn"
                        style="margin-left: auto; padding: 5px 10px; font-size: 0.8rem;">‚ñ∂ Ouvir</button>
                </label>

                <label class="sound-option"
                    style="display: flex; align-items: center; padding: 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="sound" value="chime" style="margin-right: 15px; transform: scale(1.3);">
                    <div>
                        <strong>üé∂ Chime</strong>
                        <div style="font-size: 0.85rem; color: #666;">Melodia suave ascendente</div>
                    </div>
                    <button onclick="previewSound('chime'); event.stopPropagation();" class="btn"
                        style="margin-left: auto; padding: 5px 10px; font-size: 0.8rem;">‚ñ∂ Ouvir</button>
                </label>

                <label class="sound-option"
                    style="display: flex; align-items: center; padding: 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="sound" value="bell" style="margin-right: 15px; transform: scale(1.3);">
                    <div>
                        <strong>üîî Sino</strong>
                        <div style="font-size: 0.85rem; color: #666;">Som de sino longo</div>
                    </div>
                    <button onclick="previewSound('bell'); event.stopPropagation();" class="btn"
                        style="margin-left: auto; padding: 5px 10px; font-size: 0.8rem;">‚ñ∂ Ouvir</button>
                </label>

                <label class="sound-option"
                    style="display: flex; align-items: center; padding: 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="sound" value="fanfare" style="margin-right: 15px; transform: scale(1.3);">
                    <div>
                        <strong>üé∫ Fanfarra</strong>
                        <div style="font-size: 0.85rem; color: #666;">Toque de celebra√ß√£o</div>
                    </div>
                    <button onclick="previewSound('fanfare'); event.stopPropagation();" class="btn"
                        style="margin-left: auto; padding: 5px 10px; font-size: 0.8rem;">‚ñ∂ Ouvir</button>
                </label>

                <label class="sound-option"
                    style="display: flex; align-items: center; padding: 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="sound" value="hospital"
                        style="margin-right: 15px; transform: scale(1.3);">
                    <div>
                        <strong>üè• Hospital</strong>
                        <div style="font-size: 0.85rem; color: #666;">Tom profissional de cl√≠nica</div>
                    </div>
                    <button onclick="previewSound('hospital'); event.stopPropagation();" class="btn"
                        style="margin-left: auto; padding: 5px 10px; font-size: 0.8rem;">‚ñ∂ Ouvir</button>
                </label>

                <label class="sound-option"
                    style="display: flex; align-items: center; padding: 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="sound" value="silent" style="margin-right: 15px; transform: scale(1.3);">
                    <div>
                        <strong>üîá Silencioso</strong>
                        <div style="font-size: 0.85rem; color: #666;">Sem som de alerta</div>
                    </div>
                </label>
            </div>

            <button onclick="saveSoundPreset()" class="btn btn-large"
                style="width: 100%; margin-top: 20px; background: #4CAF50;">
                üíæ Salvar Configura√ß√£o
            </button>
        </div>
    </div>

    <script src="auth-helper.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // Check authentication on page load
        checkAuth().then(user => {
            if (!user) return; // Will redirect to login
        });

        // Audio context for previewing sounds
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // Sound Presets (same as TV)
        const soundPresets = {
            'ding-dong': () => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(660, audioCtx.currentTime);
                osc.frequency.setValueAtTime(440, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.8);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.8);
            },
            'triple-beep': () => {
                for (let i = 0; i < 3; i++) {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(880, audioCtx.currentTime + i * 0.2);
                    gain.gain.setValueAtTime(0.3, audioCtx.currentTime + i * 0.2);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.2 + 0.15);
                    osc.start(audioCtx.currentTime + i * 0.2);
                    osc.stop(audioCtx.currentTime + i * 0.2 + 0.15);
                }
            },
            'chime': () => {
                const notes = [523, 659, 784, 1047];
                notes.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime + i * 0.15);
                    gain.gain.setValueAtTime(0.4, audioCtx.currentTime + i * 0.15);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.15 + 0.4);
                    osc.start(audioCtx.currentTime + i * 0.15);
                    osc.stop(audioCtx.currentTime + i * 0.15 + 0.4);
                });
            },
            'bell': () => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 1.5);
                gain.gain.setValueAtTime(0.6, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.5);
                osc.start();
                osc.stop(audioCtx.currentTime + 1.5);
            },
            'fanfare': () => {
                const notes = [392, 523, 659, 784];
                notes.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime + i * 0.2);
                    gain.gain.setValueAtTime(0.25, audioCtx.currentTime + i * 0.2);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.2 + 0.3);
                    osc.start(audioCtx.currentTime + i * 0.2);
                    osc.stop(audioCtx.currentTime + i * 0.2 + 0.3);
                });
            },
            'hospital': () => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(440, audioCtx.currentTime);
                osc.frequency.setValueAtTime(550, audioCtx.currentTime + 0.4);
                osc.frequency.setValueAtTime(440, audioCtx.currentTime + 0.8);
                gain.gain.setValueAtTime(0.4, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.2);
                osc.start();
                osc.stop(audioCtx.currentTime + 1.2);
            },
            'silent': () => { }
        };

        function previewSound(preset) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            if (soundPresets[preset]) soundPresets[preset]();
        }

        // TTS Toggle
        function toggleTTS() {
            const current = localStorage.getItem('star_tickets_tv_tts') === 'true';
            const newValue = !current;
            localStorage.setItem('star_tickets_tv_tts', newValue ? 'true' : 'false');

            // Emit to all TVs via WebSocket
            socket.emit('change_tv_tts', { enabled: newValue });

            updateTTSButton();
        }

        function updateTTSButton() {
            const enabled = localStorage.getItem('star_tickets_tv_tts') === 'true';
            const btn = document.getElementById('tts-toggle-btn');
            if (enabled) {
                btn.innerHTML = 'üîä Voz Ligada';
                btn.style.background = '#4CAF50';
            } else {
                btn.innerHTML = 'üîá Voz Desligada';
                btn.style.background = '#607D8B';
            }
        }

        // Update button on page load
        setTimeout(updateTTSButton, 100);

        function openSoundModal() {
            document.getElementById('sound-modal').classList.add('active');
            // Load current setting
            const current = localStorage.getItem('star_tickets_tv_sound') || 'ding-dong';
            const radio = document.querySelector(`input[name="sound"][value="${current}"]`);
            if (radio) radio.checked = true;
        }

        function closeSoundModal() {
            document.getElementById('sound-modal').classList.remove('active');
        }

        function saveSoundPreset() {
            const selected = document.querySelector('input[name="sound"]:checked');
            if (selected) {
                const preset = selected.value;
                localStorage.setItem('star_tickets_tv_sound', preset);

                // Emit to all TVs via WebSocket
                socket.emit('change_tv_sound', { preset });

                alert('‚úÖ Som configurado com sucesso!\n\nA TV ser√° atualizada automaticamente.');
                closeSoundModal();
            }
        }

        let currentRoomId = null;
        let selectedTicketId = null;
        let isRelocationMode = false;
        let selectedTargetRoomId = null;
        let selectedCandidateIds = new Set();

        // Load rooms - backend now filters by session automatically
        async function loadRooms() {
            try {
                const res = await fetch('/api/manager/overview');
                if (!res.ok) {
                    console.error('Error loading rooms:', res.status);
                    return;
                }
                const rooms = await res.json();

                if (isRelocationMode) {
                    renderTargetRooms(rooms);
                } else {
                    renderGrid(rooms);
                }
            } catch (e) {
                console.error('Error loading rooms:', e);
            }
        }

        function renderGrid(rooms) {
            const grid = document.getElementById('rooms-grid');
            grid.innerHTML = '';

            rooms.forEach(room => {
                const card = document.createElement('div');
                card.className = 'room-card';
                card.onclick = () => openRoomQueue(room.id, room.name);
                card.innerHTML = `
                    <h3>${room.name}</h3>
                    <div class="room-count">${room.waiting_count}</div>
                    <p>Pessoas aguardando</p>
                `;
                grid.appendChild(card);
            });
        }

        function toggleRelocationMode() {
            isRelocationMode = !isRelocationMode;
            const btn = document.getElementById('toggle-mode-btn');
            const grid = document.getElementById('rooms-grid');
            const relView = document.getElementById('relocation-view');

            if (isRelocationMode) {
                btn.innerText = 'üîô Voltar ao Painel';
                btn.style.background = '#FF9800';
                grid.style.display = 'none';
                relView.style.display = 'grid';
                loadRooms(); // Reload to populate list
            } else {
                btn.innerText = 'üîÑ Modo Remanejamento';
                btn.style.background = '';
                grid.style.display = 'grid';
                relView.style.display = 'none';
                loadRooms(); // Reload to populate grid

                // Reset states
                selectedTargetRoomId = null;
                selectedCandidateIds.clear();
                updateActionUI();
            }
        }

        async function renderTargetRooms(rooms) {
            const list = document.getElementById('target-rooms-list');
            list.innerHTML = '';

            for (const room of rooms) {
                // Fetch services for this room
                const servicesRes = await fetch(`/api/rooms/${room.id}/services`);
                let servicesText = '';
                if (servicesRes.ok) {
                    const services = await servicesRes.json();
                    if (services.length > 0) {
                        servicesText = `<div style="font-size:0.75rem; color:#999; margin-top:3px;">${services.map(s => s.name).join(', ')}</div>`;
                    }
                }

                const div = document.createElement('div');
                div.className = `list-item ${selectedTargetRoomId === room.id ? 'active' : ''}`;
                div.innerHTML = `
                    <strong>${room.name}</strong> 
                    <span style="float:right; color:#666;">${room.waiting_count} na fila</span>
                    ${servicesText}
                `;
                div.onclick = () => selectTargetRoom(room.id);
                list.appendChild(div);
            }
        }

        async function selectTargetRoom(roomId) {
            selectedTargetRoomId = roomId;
            selectedCandidateIds.clear();
            updateActionUI();
            loadRooms(); // Re-render to update active class

            // Load Candidates
            const list = document.getElementById('candidates-list');
            list.innerHTML = '<p style="text-align:center; color:#666;">Carregando...</p>';

            try {
                const res = await fetch(`/api/manager/candidates/${roomId}`);
                const candidates = await res.json();
                renderCandidates(candidates);
            } catch (e) {
                list.innerHTML = '<p style="color:red; text-align:center;">Erro ao carregar candidatos</p>';
            }
        }

        function renderCandidates(candidates) {
            const list = document.getElementById('candidates-list');
            list.innerHTML = '';

            if (candidates.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">Nenhum candidato encontrado para esta sala.</p>';
                return;
            }

            function renderCandidates(candidates) {
                const list = document.getElementById('candidates-list');
                list.innerHTML = '';

                if (candidates.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">Nenhum candidato encontrado para esta sala.</p>';
                    return;
                }

                // Group candidates by current room
                const groupedByRoom = {};
                candidates.forEach(c => {
                    const roomKey = c.current_room_name || 'Sem Sala Definida';
                    if (!groupedByRoom[roomKey]) {
                        groupedByRoom[roomKey] = [];
                    }
                    groupedByRoom[roomKey].push(c);
                });

                // Render each group
                Object.keys(groupedByRoom).sort().forEach(roomName => {
                    const roomCandidates = groupedByRoom[roomName];

                    // Room header with group checkbox
                    const headerDiv = document.createElement('div');
                    headerDiv.style.cssText = 'background:#e3f2fd; padding:10px; margin-top:10px; border-radius:5px; font-weight:bold; display:flex; align-items:center; cursor:pointer;';

                    const groupCheckbox = document.createElement('input');
                    groupCheckbox.type = 'checkbox';
                    groupCheckbox.style.cssText = 'margin-right:10px; transform:scale(1.3);';
                    groupCheckbox.onchange = (e) => {
                        e.stopPropagation();
                        toggleGroupSelection(roomCandidates, e.target.checked);
                    };

                    const headerText = document.createElement('span');
                    headerText.innerHTML = `üìç ${roomName} <span style="color:#666; font-weight:normal; margin-left:10px;">(${roomCandidates.length} ${roomCandidates.length === 1 ? 'pessoa' : 'pessoas'})</span>`;
                    headerText.onclick = () => {
                        groupCheckbox.checked = !groupCheckbox.checked;
                        toggleGroupSelection(roomCandidates, groupCheckbox.checked);
                    };

                    headerDiv.appendChild(groupCheckbox);
                    headerDiv.appendChild(headerText);
                    list.appendChild(headerDiv);

                    // Render candidates in this group
                    roomCandidates.forEach(c => {
                        const div = document.createElement('div');
                        div.className = 'candidate-item';
                        div.style.marginLeft = '20px';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = c.ticket_id;
                        checkbox.className = `room-checkbox-${roomName.replace(/\s+/g, '-')}`;
                        checkbox.onchange = (e) => {
                            toggleCandidate(c.ticket_id, e.target.checked);
                            updateGroupCheckbox(roomName);
                        };

                        // Build services list
                        let servicesHTML = '';
                        if (c.pending_services && c.pending_services.length > 0) {
                            const servicesList = c.pending_services.map((svc, idx) => {
                                const isCurrent = idx === 0;
                                const badge = isCurrent ? '<span style="background:#4CAF50; color:white; padding:2px 6px; border-radius:3px; font-size:0.65rem; margin-left:5px;">ATUAL</span>' : '';
                                return `<span style="color: ${isCurrent ? '#2e7d32' : '#666'}; font-size:0.75rem;">${svc.name}${badge}</span>`;
                            }).join(' ‚Üí ');
                            servicesHTML = `
                            <div style="font-size:0.75rem; margin-top:5px; padding:5px; background:#f9f9f9; border-radius:3px;">
                                üìã ${servicesList}
                            </div>
                        `;
                        }

                        const infoDiv = document.createElement('div');
                        infoDiv.style.flex = '1';
                        infoDiv.innerHTML = `
                        <div style="font-weight:bold; font-size:0.9rem;">${c.display_code} - ${c.temp_customer_name}</div>
                        <div style="font-size:0.75rem; color:#666; margin-top:2px;">
                            üïê Aguardando: <strong>${c.current_service_name}</strong>
                        </div>
                        ${servicesHTML}
                    `;

                        div.appendChild(checkbox);
                        div.appendChild(infoDiv);
                        list.appendChild(div);
                    });
                });
            }

            function toggleGroupSelection(roomCandidates, checked) {
                roomCandidates.forEach(c => {
                    const checkbox = document.querySelector(`input[value="${c.ticket_id}"]`);
                    if (checkbox) {
                        checkbox.checked = checked;
                        toggleCandidate(c.ticket_id, checked);
                    }
                });
            }

            function updateGroupCheckbox(roomName) {
                const roomKey = roomName.replace(/\s+/g, '-');
                const checkboxes = document.querySelectorAll(`.room-checkbox-${roomKey}`);
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                const anyChecked = Array.from(checkboxes).some(cb => cb.checked);

                // Find the group checkbox (it's the first checkbox in the header)
                const headers = document.querySelectorAll('#candidates-list > div');
                headers.forEach(header => {
                    if (header.textContent.includes(roomName)) {
                        const groupCheckbox = header.querySelector('input[type="checkbox"]');
                        if (groupCheckbox) {
                            groupCheckbox.checked = allChecked;
                            groupCheckbox.indeterminate = !allChecked && anyChecked;
                        }
                    }
                });
            }
        }

        function toggleCandidate(ticketId, checked) {
            if (checked) {
                selectedCandidateIds.add(ticketId);
            } else {
                selectedCandidateIds.delete(ticketId);
            }
            updateActionUI();
        }

        function toggleAllCandidates(sourceCheckbox) {
            const checkboxes = document.querySelectorAll('#candidates-list input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = sourceCheckbox.checked;
                // Trigger change event logic manually since setting checked property doesn't fire it
                toggleCandidate(parseInt(cb.value), sourceCheckbox.checked);
            });
        }

        function updateActionUI() {
            const count = selectedCandidateIds.size;
            const summary = document.getElementById('action-summary');
            const btn = document.getElementById('move-btn');

            if (count > 0) {
                summary.innerHTML = `<strong>${count}</strong> clientes selecionados<br>para mover para a sala selecionada.`;
                btn.disabled = false;
                btn.style.opacity = '1';
            } else {
                summary.innerText = 'Nenhum candidato selecionado';
                btn.disabled = true;
                btn.style.opacity = '0.5';
            }
        }

        async function executeBulkMove() {
            console.log('executeBulkMove called');
            console.log('selectedTargetRoomId:', selectedTargetRoomId);
            console.log('selectedCandidateIds:', selectedCandidateIds);

            if (!selectedTargetRoomId || selectedCandidateIds.size === 0) {
                console.log('Returning early - no room or candidates');
                alert('Por favor, selecione uma sala de destino e pelo menos um candidato.');
                return;
            }

            if (!confirm(`Tem certeza que deseja mover ${selectedCandidateIds.size} clientes para esta sala agora?`)) {
                console.log('User cancelled confirm');
                return;
            }

            const btn = document.getElementById('move-btn');
            btn.innerText = 'Movendo...';
            btn.disabled = true;

            try {
                console.log('Making fetch request...');
                const res = await fetch('/api/manager/bulk-prioritize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ticketIds: Array.from(selectedCandidateIds),
                        targetRoomId: selectedTargetRoomId
                    })
                });

                console.log('Response status:', res.status);

                if (res.ok) {
                    alert('Clientes movidos com sucesso!');
                    // Refresh
                    selectTargetRoom(selectedTargetRoomId);
                } else {
                    const errorText = await res.text();
                    console.error('Error response:', errorText);
                    alert('Erro ao mover clientes: ' + errorText);
                }
            } catch (e) {
                console.error('Exception:', e);
                alert('Erro de conex√£o: ' + e.message);
            } finally {
                btn.innerText = 'MOVER AGORA';
            }
        }

        async function openRoomQueue(roomId, roomName) {
            currentRoomId = roomId;
            document.getElementById('modal-title').innerText = `Fila: ${roomName}`;
            document.getElementById('queue-modal').classList.add('active');
            document.getElementById('optimization-panel').style.display = 'none';
            selectedTicketId = null;

            loadQueueDetails(roomId);
        }

        async function loadQueueDetails(roomId) {
            const res = await fetch(`/api/manager/room/${roomId}/queue`);
            const tickets = await res.json();

            const list = document.getElementById('modal-ticket-list');
            list.innerHTML = '';

            if (tickets.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#999;">Fila vazia</p>';
                return;
            }

            tickets.forEach(t => {
                const div = document.createElement('div');
                div.className = 'ticket-item';
                if (selectedTicketId === t.ticket_id) div.classList.add('selected');

                div.onclick = () => selectTicket(t);

                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${t.display_code}</strong>
                        <span>${t.temp_customer_name || 'Sem nome'}</span>
                    </div>
                    <div style="font-size:0.9rem; color:#666; margin-top:5px;">
                        Servi√ßo Atual: ${t.service_name}
                    </div>
                    ${t.other_services_count > 0 ?
                        `<div style="font-size:0.8rem; color:#e65100; margin-top:5px;">
                            + ${t.other_services_count} outros servi√ßos pendentes
                        </div>` : ''
                    }
                `;
                list.appendChild(div);
            });
        }

        async function selectTicket(ticket) {
            selectedTicketId = ticket.ticket_id;

            // Highlight selection
            document.querySelectorAll('.ticket-item').forEach(el => el.classList.remove('selected'));
            // Re-render list to show selection (simple way)
            loadQueueDetails(currentRoomId);

            // Show optimization panel
            const panel = document.getElementById('optimization-panel');
            panel.style.display = 'block';
            document.getElementById('opt-ticket-code').innerText = ticket.display_code;

            // Fetch pending services for this ticket
            const res = await fetch(`/api/tickets/${ticket.ticket_id}/services`); // Reusing existing endpoint
            const services = await res.json();

            const list = document.getElementById('opt-services-list');
            list.innerHTML = '';

            // Filter only pending services
            const pendingServices = services.filter(s => s.status === 'PENDING');

            pendingServices.forEach((s, index) => {
                const div = document.createElement('div');
                div.className = 'pending-service';

                const isCurrent = index === 0;

                div.innerHTML = `
                    <div>
                        ${isCurrent ? '<span class="badge" style="background:#c8e6c9; color:#2e7d32;">ATUAL</span>' : ''}
                        <strong>${s.service_name}</strong>
                    </div>
                    ${!isCurrent ? `
                        <button class="btn btn-small" onclick="prioritizeService(${s.id})" style="font-size:0.8rem; padding:5px 10px;">
                            ‚¨Ü Priorizar
                        </button>
                    ` : ''}
                `;
                list.appendChild(div);
            });
        }

        async function prioritizeService(ticketServiceId) {
            if (!confirm('Deseja mover este servi√ßo para o topo da lista de prioridades deste cliente?')) return;

            await fetch(`/api/tickets/services/${ticketServiceId}/prioritize`, {
                method: 'PUT'
            });

            // Refresh
            loadQueueDetails(currentRoomId);
            // Also refresh the optimization panel details
            if (selectedTicketId) {
                // Re-select to refresh panel
                // We need the ticket object, but we only have ID here. 
                // Simple hack: hide panel to force re-selection or just leave it stale until clicked again.
                // Better: fetch ticket details again.
                document.getElementById('optimization-panel').style.display = 'none';
            }
        }

        function closeModal() {
            document.getElementById('queue-modal').classList.remove('active');
            currentRoomId = null;
        }

        // Auto refresh
        setInterval(() => {
            if (!currentRoomId && !isRelocationMode) loadRooms();
        }, 5000);

        loadRooms();
    </script>
</body>

</html>