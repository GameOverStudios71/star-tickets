<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Tickets - Recep√ß√£o</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        .reception-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 80px);
            /* Altura total menos header */
            overflow: hidden;
        }

        .reception-layout>div {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .ticket-list-container {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            /* Importante para flexbox */
            padding-right: 10px;
        }

        /* Scrollbar customizada - estilo fino */
        .ticket-list-container::-webkit-scrollbar {
            width: 4px;
        }

        .ticket-list-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
        }

        .ticket-list-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 2px;
        }

        .ticket-list-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.8);
        }

        /* Firefox scrollbar */
        .ticket-list-container {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.6) rgba(255, 255, 255, 0.05);
        }

        .tickets-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: rgba(var(--acrylic-base-color), 0.1);
            backdrop-filter: blur(var(--acrylic-blur));
            -webkit-backdrop-filter: blur(var(--acrylic-blur));
            border: 1px solid rgba(var(--acrylic-base-color), 0.2);
            border-radius: 8px;
            padding: 20px;
            color: white;
        }

        .filter-section {
            background: rgba(var(--acrylic-base-color), 0.1);
            backdrop-filter: blur(var(--acrylic-blur));
            -webkit-backdrop-filter: blur(var(--acrylic-blur));
            border: 1px solid rgba(var(--acrylic-base-color), 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            color: white;
        }

        .ticket-card {
            background: rgba(var(--acrylic-base-color), 0.1);
            backdrop-filter: blur(var(--acrylic-blur));
            -webkit-backdrop-filter: blur(var(--acrylic-blur));
            border: 1px solid rgba(var(--acrylic-base-color), 0.2);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .ticket-card:hover {
            background: rgba(var(--acrylic-base-color), 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .ticket-card.selected {
            border: 4px solid #27ae60;
            background: rgba(39, 174, 96, 0.1);
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.3);
        }

        /* Ticket em atendimento na pr√≥pria mesa */
        .ticket-card.in-progress-my-desk {
            background: rgba(76, 175, 80, 0.15) !important;
            border: none !important;
        }

        .ticket-card.in-progress-my-desk:hover {
            background: rgba(76, 175, 80, 0.25) !important;
        }

        .ticket-card.in-progress-other {
            border: none !important;
            background: rgba(244, 67, 54, 0.15) !important;
            cursor: not-allowed;
            opacity: 0.9;
        }

        .ticket-card.in-progress-other:hover {
            transform: none;
            box-shadow: none;
            background: rgba(244, 67, 54, 0.25) !important;
        }

        /* Cor branca para o texto do conv√™nio em tickets bloqueados ou em atendimento */
        .ticket-card.in-progress-other div,
        .ticket-card.in-progress-my-desk div {
            color: white !important;
        }

        .attending-badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 10px;
        }

        .ticket-code {
            font-size: 1.3rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }

        .ticket-services {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .ticket-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.75rem;
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .ticket-status.linked {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .detail-panel {
            background: rgba(var(--acrylic-base-color), 0.15);
            backdrop-filter: blur(var(--acrylic-blur));
            -webkit-backdrop-filter: blur(var(--acrylic-blur));
            border: 1px solid rgba(var(--acrylic-base-color), 0.2);
            padding: 20px;
            border-radius: 8px;
            height: 100%;
            overflow-y: auto;
            color: white;
        }

        /* Scrollbar customizada detail-panel */
        .detail-panel::-webkit-scrollbar {
            width: 4px;
        }

        .detail-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
        }

        .detail-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 2px;
        }

        .detail-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.8);
        }

        /* Firefox scrollbar */
        .detail-panel {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.6) rgba(255, 255, 255, 0.05);
        }

        /* Estilo das op√ß√µes dos dropdowns */
        select option {
            background: #2a2a2a;
            color: white;
        }

        select option:checked {
            background: white;
            color: #333;
        }

        .service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 8px;
            border-radius: 5px;
            color: white;
        }

        .service-item .service-info {
            flex: 1;
        }

        .service-item .service-actions {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .service-item button {
            padding: 5px 10px;
            font-size: 0.85rem;
        }

        .btn-call {
            width: 100%;
            padding: 15px;
            background: #27ae60;
            /* Green */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .btn-call:hover {
            background: #2ecc71;
        }

        .arrow-btn {
            background: white;
            color: var(--primary-color);
            border: none;
            padding: 3px 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 1rem;
        }

        .arrow-btn:hover {
            opacity: 0.8;
        }

        .arrow-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            padding: 40px;
        }

        .add-service-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
        }

        .add-service-section select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }

        /* Tabs Styles */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 0;
        }

        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px 5px 0 0;
        }

        .tab-btn.active {
            color: #fff;
            border-bottom-color: #fff;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px 5px 0 0;
        }

        /* Modal de Ticket Bloqueado */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: modalSlideUp 0.3s ease-out;
        }

        @keyframes modalSlideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .modal-title {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 1.5rem;
        }

        .modal-message {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        /* Enforce Desk Selection */
        .disabled-state {
            opacity: 0.5;
            pointer-events: none;
            position: relative;
            filter: grayscale(0.8);
            transition: all 0.3s;
        }

        .desk-required-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .desk-required-msg {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }
    </style>
</head>

<body class="has-background">
    <header id="reception-header"></header>

    <div class="reception-layout">
        <!-- Left Column: Filters + Ticket List -->
        <div class="left-column" id="reception-left-column"
            style="display: flex; flex-direction: column; gap: 20px; position: relative;">

            <!-- Overlay for Desk Requirement -->
            <div id="desk-overlay" class="desk-required-overlay" style="display: flex;">
                <div class="desk-required-msg">
                    <span>Selecione sua mesa acima<br>para come√ßar</span>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filter-section">

                <!-- Advanced Filters -->
                <div style="margin-bottom: 15px;">
                    <h3 style="cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between; font-size: 1rem;"
                        onclick="toggleTypeFilterDropdown()">
                        <span>Filtrar por Tipo</span>
                        <span id="type-filter-arrow" style="transition: transform 0.3s;">‚ñº</span>
                    </h3>
                    <div id="type-filter-dropdown"
                        style="display: none; margin-top: 10px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" id="filter-insurance" onchange="applyFilters()">
                                <span>üí≥ Conv√™nio</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" id="filter-private" onchange="applyFilters()">
                                <span>üíµ Particular</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" id="filter-normal" onchange="applyFilters()">
                                <span>üë§ Normal</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" id="filter-priority" onchange="applyFilters()">
                                <span>‚≠ê Preferencial</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" id="filter-work-medicine" onchange="applyFilters()">
                                <span>üíº Med. Trabalho</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" id="filter-clinical-analysis" onchange="applyFilters()">
                                <span>üî¨ An√°lises Cl√≠n.</span>
                            </label>
                        </div>
                    </div>
                </div>

                <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.2); margin: 15px 0;">

                <h3 style="cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between; font-size: 1rem;"
                    onclick="toggleFilterDropdown()">
                    <span>Filtrar por Servi√ßo</span>
                    <span id="filter-arrow" style="transition: transform 0.3s;">‚ñº</span>
                </h3>
                <div id="filter-dropdown"
                    style="display: none; max-height: 300px; overflow-y: auto; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                    <div style="margin-bottom: 10px;">
                        <button class="btn" onclick="selectAllFilters()"
                            style="font-size: 0.85rem; padding: 5px 10px;">Selecionar Todos</button>
                        <button class="btn" onclick="clearAllFilters()"
                            style="font-size: 0.85rem; padding: 5px 10px; margin-left: 5px;">Limpar Todos</button>
                    </div>
                    <div class="filter-checkboxes" id="filter-checkboxes">
                        <!-- Checkboxes will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Ticket List with Tabs -->
            <div class="tickets-card">
                <!-- Tabs Header -->
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('active')" id="tab-active">
                        ‚è≥ Aguardando e Atendimento
                    </button>
                    <button class="tab-btn" onclick="switchTab('finished')" id="tab-finished">
                        ‚úÖ Finalizados
                    </button>
                </div>

                <div class="ticket-list-container">
                    <div id="ticket-list"></div>
                </div>
            </div>
        </div>

        <!-- Right Column: Detail Panel -->
        <div>
            <div class="detail-panel" id="detail-panel">
                <div class="empty-state">
                    <p>üëà Selecione uma senha para ver os detalhes</p>
                </div>
            </div>
        </div>
    </div>

    <script src="auth-helper.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let selectedTicket = null;
        let allTickets = [];
        let allServices = [];
        let allDesks = [];
        let selectedFilters = new Set();
        let currentTab = 'active'; // 'active' or 'finished'

        // Check authentication on page load
        checkAuth().then(async user => {
            if (!user) return; // Will redirect to login
            currentUser = user;
            await renderReceptionHeader(); // Render header first to create desk-select element
            loadDesks(); // Loads desks AND tries to join saved desk
        });

        // Socket Listeners for Desks
        socket.on('active_desks_update', (data) => {
            activeDesks = new Map(data);
            if (allDesks.length > 0) renderDesksDropdown();
        });

        socket.on('desk_join_success', (data) => {
            localStorage.setItem('star_tickets_reception_desk', data.deskId);
            setCookie('star_tickets_reception_desk', data.deskId, 30); // 30 days

            // Unlock UI
            toggleDeskOverlay(false);

            if (!isAutoJoining) {
                // Se foi troca manual, recarrega a p√°gina para atualizar tudo do zero na nova mesa
                document.querySelector('.desk-selector').style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
                showToast(`Mesa altera com sucesso! Atualizando...`, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                // Reconex√£o autom√°tica ao abrir a p√°gina
                document.querySelector('.desk-selector').style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
                console.log('Mesa reconectada automaticamente');
                isAutoJoining = false; // Reset flag

                // Re-renderizar tickets para aplicar cores corretas (verde/vermelho)
                renderTickets(filterTickets(allTickets));
            }
        });

        socket.on('desk_join_error', (data) => {
            if (!isAutoJoining) {
                showWarningModal('Falha ao selecionar mesa', data.message);
            } else {
                console.warn('Falha na reconex√£o autom√°tica:', data.message);
                isAutoJoining = false;
            }

            // Revert
            const select = document.getElementById('desk-select');
            select.value = "";

            localStorage.removeItem('star_tickets_reception_desk');
            setCookie('star_tickets_reception_desk', "", -1);

            document.querySelector('.desk-selector').style.background = 'linear-gradient(135deg, #0a3d3e 0%, #0d4d4f 100%)';

            // Lock UI
            toggleDeskOverlay(true);
        });

        function toggleDeskOverlay(show) {
            const overlay = document.getElementById('desk-overlay');
            const leftCol = document.getElementById('reception-left-column');
            const filters = document.querySelector('.filter-section');
            const list = document.querySelector('.tickets-card');

            if (show) {
                overlay.style.display = 'flex';
                if (filters) filters.classList.add('disabled-state');
                if (list) list.classList.add('disabled-state');
            } else {
                overlay.style.display = 'none';
                if (filters) filters.classList.remove('disabled-state');
                if (list) list.classList.remove('disabled-state');
            }
        }

        // Load reception desks - backend now filters by session automatically
        async function loadDesks() {
            try {
                const res = await fetch('/api/reception-desks');
                if (res.ok) {
                    allDesks = await res.json();
                } else {
                    allDesks = [];
                    console.error('Error loading desks:', res.status);
                }
                renderDesksDropdown();
                tryJoinSavedDesk(); // Try to join only once after loading desks
            } catch (e) {
                console.error('Error loading desks:', e);
            }
        }

        // Flag to suppress success toast on auto-join
        let isAutoJoining = false;

        // Cookie Helpers
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                let date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        function getCookie(name) {
            let nameEQ = name + "=";
            let ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Tries to join the desk saved in localStorage OR cookie (only if not taken)
        function tryJoinSavedDesk() {
            // Priority: LocalStorage -> Cookie
            const savedDeskId = localStorage.getItem('star_tickets_reception_desk') || getCookie('star_tickets_reception_desk');

            if (savedDeskId && currentUser) {
                const occupant = activeDesks.get(parseInt(savedDeskId));
                // Only join if not occupied OR occupied by me
                if (!occupant || occupant.userName === currentUser.username) {
                    isAutoJoining = true; // Suppress toast
                    socket.emit('join_desk', {
                        deskId: parseInt(savedDeskId),
                        userName: currentUser.username,
                        userId: currentUser.id
                    });
                } else {
                    // It's taken by someone else, clear saved data
                    localStorage.removeItem('star_tickets_reception_desk');
                    setCookie('star_tickets_reception_desk', "", -1);
                    renderDesksDropdown();
                }
            }
        }

        function renderDesksDropdown() {
            const select = document.getElementById('desk-select');
            if (!select) {
                console.warn('desk-select element not found, header may not be rendered yet');
                return;
            }
            // Save current selection to restore visual state
            // Priority: Current Value (User Input) > LocalStorage > Empty
            // This prevents the dropdown from reverting to the old value while waiting for success confirmation
            const currentSelection = select.value || localStorage.getItem('star_tickets_reception_desk');

            select.innerHTML = '<option value="">Selecione...</option>';

            allDesks.forEach(desk => {
                const option = document.createElement('option');
                option.value = desk.id;

                // Check if occupied
                const occupant = activeDesks.get(desk.id);
                // Occupied if exists AND not by me (if I'm logged in)
                const isOccupied = occupant && (!currentUser || occupant.userName !== currentUser.username);

                if (isOccupied) {
                    option.textContent = `${desk.name} (Usada por ${occupant.userName})`;
                    option.disabled = true;
                    option.style.background = '#ffebee';
                } else {
                    option.textContent = desk.name;
                }

                select.appendChild(option);
            });

            // Restore selection if valid
            if (currentSelection) {
                // Check if it's still valid in the new options
                const optionToSelect = select.querySelector(`option[value="${currentSelection}"]`);
                if (optionToSelect && !optionToSelect.disabled) {
                    select.value = currentSelection;
                } else {
                    // It got disabled or doesn't exist, clear invalid selection
                    if (localStorage.getItem('star_tickets_reception_desk') === currentSelection) {
                        localStorage.removeItem('star_tickets_reception_desk');
                    }
                    select.value = "";
                }
            } else {
                select.value = "";
            }
        }

        // Active Desks Map: deskId -> { socketId, userName }
        let activeDesks = new Map();
        let currentUser = null; // Will be set after checkAuth

        // Custom header renderer for reception that includes desk selector
        async function renderReceptionHeader() {
            let user = null;
            try {
                const authRes = await fetch('/api/auth/me');
                if (authRes.ok) {
                    const data = await authRes.json();
                    user = data.user;
                }
            } catch (e) {
                console.error('Error fetching user:', e);
            }

            const header = document.getElementById('reception-header');
            if (!header) return;

            // Adicionar classe app-header ao elemento pai para evitar fundo duplo
            header.className = 'app-header';

            header.innerHTML = `
                <div class="header-left">
                    <h1>Recep√ß√£o / Triagem</h1>
                </div>
                <div class="header-right" style="display: flex; align-items: center; gap: 20px;">
                    <div class="desk-selector" style="display: flex; align-items: center; gap: 10px; background: linear-gradient(135deg, #0a3d3e 0%, #0d4d4f 100%); padding: 10px 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(10, 61, 62, 0.3);">
                        <label for="desk-select" style="font-weight: 500; color: white;">ü™ë Minha Mesa:</label>
                        <select id="desk-select" onchange="handleDeskSelection()" style="padding: 8px 15px; border-radius: 5px; border: none; font-size: 1rem; min-width: 150px; cursor: pointer;">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    ${user ? `
                    <div class="user-profile">
                        <div class="user-avatar">
                            ${user.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="user-info">
                            <span class="user-name">${user.name}</span>
                            <span class="user-role">${user.role}</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function handleDeskSelection() {
            const select = document.getElementById('desk-select');
            const deskId = select.value;

            if (!deskId) {
                // User deselected desk
                socket.emit('leave_desk');
                localStorage.removeItem('star_tickets_reception_desk');
                document.querySelector('.desk-selector').style.background = 'linear-gradient(135deg, #0a3d3e 0%, #0d4d4f 100%)';

                // Show blocking overlay
                toggleDeskOverlay(true);
                return;
            }

            // Check if desk is already occupied locally (optimistic check)
            const deskOccupant = activeDesks.get(parseInt(deskId));
            if (deskOccupant && (!currentUser || deskOccupant.userName !== currentUser.username)) {
                showWarningModal('Mesa Ocupada', `A mesa <strong>${getDeskName(deskId)}</strong> j√° est√° sendo usada por <strong>${deskOccupant.userName}</strong>.`);
                // Revert selection
                const savedDesk = localStorage.getItem('star_tickets_reception_desk');
                select.value = savedDesk || "";
                return;
            }

            // Attempt to join desk
            if (currentUser) {
                // Save selection to storage and cookie
                localStorage.setItem('star_tickets_reception_desk', deskId);
                setCookie('star_tickets_reception_desk', deskId, 30); // Save for 30 days

                socket.emit('join_desk', {
                    deskId: parseInt(deskId),
                    userName: currentUser.username,
                    userId: currentUser.id
                });

                // Re-renderizar tickets para aplicar cores corretas (verde/vermelho)
                setTimeout(() => {
                    renderTickets(filterTickets(allTickets));
                }, 100);
            }
        }

        // Helper to get desk name by ID
        function getDeskName(id) {
            const desk = allDesks.find(d => d.id == id);
            return desk ? desk.name : 'Mesa ' + id;
        }

        function getSelectedDeskId() {
            const select = document.getElementById('desk-select');
            if (!select) return null;
            return select.value ? parseInt(select.value) : null;
        }

        async function loadServices() {
            const res = await fetch('/api/admin/services');
            allServices = await res.json();
            renderFilters();
        }

        function renderFilters() {
            const container = document.getElementById('filter-checkboxes');
            container.innerHTML = '';

            allServices.forEach(service => {
                const label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.gap = '5px';
                label.style.cursor = 'pointer';
                label.innerHTML = `
                    <input type="checkbox" value="${service.id}" onchange="toggleFilter(${service.id})">
                    <span style="font-size: 0.9rem;">${service.name}</span>
                `;
                container.appendChild(label);
            });
        }

        function toggleTypeFilterDropdown() {
            const dropdown = document.getElementById('type-filter-dropdown');
            const arrow = document.getElementById('type-filter-arrow');
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                dropdown.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function toggleTypeFilterDropdown() {
            const dropdown = document.getElementById('type-filter-dropdown');
            const arrow = document.getElementById('type-filter-arrow');
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                dropdown.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function toggleFilterDropdown() {
            const dropdown = document.getElementById('filter-dropdown');
            const arrow = document.getElementById('filter-arrow');

            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                dropdown.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function selectAllFilters() {
            const checkboxes = document.querySelectorAll('#filter-checkboxes input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (!cb.checked) {
                    cb.checked = true;
                    toggleFilter(parseInt(cb.value));
                }
            });
        }

        function clearAllFilters() {
            const checkboxes = document.querySelectorAll('#filter-checkboxes input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    cb.checked = false;
                }
            });
            selectedFilters.clear();
            renderTickets(filterTickets(allTickets));
        }

        function toggleFilter(serviceId) {
            if (selectedFilters.has(serviceId)) {
                selectedFilters.delete(serviceId);
            } else {
                selectedFilters.add(serviceId);
            }
            renderTickets(filterTickets(allTickets));
        }

        function filterTickets(tickets) {
            let filtered = tickets;

            // 1. Filter by Tab
            if (currentTab === 'active') {
                // Show Waiting, Called, and In Reception
                filtered = filtered.filter(t => ['WAITING_RECEPTION', 'CALLED_RECEPTION', 'IN_RECEPTION'].includes(t.status));
            } else {
                // Show everything else (Processed/Finished by reception)
                filtered = filtered.filter(t => !['WAITING_RECEPTION', 'CALLED_RECEPTION', 'IN_RECEPTION'].includes(t.status));
            }

            // 2. Advanced Filters
            const filterInsurance = document.getElementById('filter-insurance').checked;
            const filterPrivate = document.getElementById('filter-private').checked;
            const filterNormal = document.getElementById('filter-normal').checked;
            const filterPriority = document.getElementById('filter-priority').checked;
            const filterWorkMedicine = document.getElementById('filter-work-medicine').checked;
            const filterClinicalAnalysis = document.getElementById('filter-clinical-analysis').checked;

            // Only apply if at least one is checked
            if (filterInsurance || filterPrivate || filterNormal || filterPriority || filterWorkMedicine || filterClinicalAnalysis) {
                filtered = filtered.filter(t => {
                    let matches = false;

                    // Ticket Type Logic (OR)
                    if (filterInsurance && t.health_insurance_name) matches = true;
                    if (filterPrivate && !t.health_insurance_name) matches = true;
                    if (filterNormal && t.is_priority === 0) matches = true;
                    if (filterPriority && t.is_priority === 1) matches = true;

                    // Service Category Logic (OR)
                    // We need to check if the ticket has services belonging to these categories
                    // Med Trabalho = Category ID 2
                    // Analises Clinicas = Category ID 1
                    if (filterWorkMedicine || filterClinicalAnalysis) {
                        const ticketServiceIds = t.services_list ? t.services_list.split(', ').map(name => {
                            const s = allServices.find(srv => srv.name === name);
                            return s ? s.id : null;
                        }).filter(id => id) : [];

                        // We need to find the parent category for these services
                        // Since we don't have the full tree here easily, we can infer from service IDs or prefixes if possible,
                        // OR we can fetch the service details.
                        // However, a simpler way given the current data structure might be to check service prefixes if they are consistent,
                        // OR rely on the fact that we loaded `allServices` which might have `establishment_id` or we can try to match names.

                        // BETTER APPROACH: The user said "Medicina do Trabalho" and "Analises Clinicas".
                        // In `init.js`, Med Trabalho services have specific prefixes or IDs.
                        // Let's check against the known prefixes from init.js for robustness.

                        const medTrabalhoPrefixes = ['ADM', 'MED', 'MTP', 'OCU', 'RAT'];
                        const analisesPrefixes = ['ANA', 'EXS', 'TRC'];

                        const ticketPrefixes = ticketServiceIds.map(id => {
                            const s = allServices.find(srv => srv.id === id);
                            return s ? s.prefix : '';
                        });

                        if (filterWorkMedicine && ticketPrefixes.some(p => medTrabalhoPrefixes.includes(p))) matches = true;
                        if (filterClinicalAnalysis && ticketPrefixes.some(p => analisesPrefixes.includes(p))) matches = true;
                    }

                    return matches;
                });
            }

            // 3. Filter by Services
            if (selectedFilters.size > 0) {
                filtered = filtered.filter(ticket => {
                    const ticketServiceIds = ticket.services_list ?
                        ticket.services_list.split(', ').map(name => {
                            const service = allServices.find(s => s.name === name);
                            return service ? service.id : null;
                        }).filter(id => id !== null) : [];

                    return ticketServiceIds.some(id => selectedFilters.has(id));
                });
            }

            return filtered;
        }

        function switchTab(tabName) {
            currentTab = tabName;

            // Update UI
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Clear selection when switching tabs to avoid confusion
            selectedTicket = null;
            document.getElementById('detail-panel').innerHTML = `
                <div class="empty-state">
                    <p>üëà Selecione uma senha para ver os detalhes</p>
                </div>
            `;

            renderTickets(filterTickets(allTickets));
        }

        async function loadTickets() {
            // Show Skeletons
            const container = document.getElementById('ticket-list');
            container.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const div = document.createElement('div');
                div.className = 'ticket-card';
                div.style.pointerEvents = 'none'; // Prevenir cliques
                div.innerHTML = `
                    <div class="ticket-code"><span class="skeleton skeleton-text" style="width: 80px; height: 1.2em;"></span></div>
                    <div class="ticket-services"><span class="skeleton skeleton-text" style="width: 100%;"></span></div>
                    <span class="ticket-status" style="width: 100px; height: 1.5em; padding:0; display:inline-block;"><span class="skeleton skeleton-block" style="border-radius:3px;"></span></span>
                `;
                container.appendChild(div);
            }

            const res = await fetch('/api/tickets');
            allTickets = await res.json();

            // Populate insurance filter dropdown with unique values
            // populateInsuranceFilter(); // REMOVED: Replaced by advanced filters

            renderTickets(filterTickets(allTickets));

            // Re-render detail if a ticket is selected
            if (selectedTicket) {
                const updated = allTickets.find(t => t.id === selectedTicket.id);
                if (updated) {
                    selectedTicket = updated;
                    showTicketDetail(selectedTicket);
                }
            }
        }



        function applyFilters() {
            renderTickets(filterTickets(allTickets));
        }

        function renderTickets(tickets) {
            const container = document.getElementById('ticket-list');
            container.innerHTML = '';

            if (tickets.length === 0) {
                container.innerHTML = '<p style="color:#999; text-align:center; padding:20px;">Nenhuma senha encontrada</p>';
                return;
            }

            const myDeskId = getSelectedDeskId();

            tickets.forEach((t, index) => {
                const div = document.createElement('div');
                div.className = 'ticket-card';

                // Verificar se est√° sendo atendido por outra mesa
                const ticketDeskId = t.reception_desk_id ? parseInt(t.reception_desk_id) : null;
                const isInProgressByOther = (t.status === 'IN_RECEPTION' || t.status === 'CALLED_RECEPTION')
                    && ticketDeskId
                    && myDeskId
                    && ticketDeskId !== myDeskId;

                // Verificar se est√° em atendimento na pr√≥pria mesa
                const isInProgressMyDesk = (t.status === 'IN_RECEPTION' || t.status === 'CALLED_RECEPTION')
                    && ticketDeskId
                    && myDeskId
                    && ticketDeskId === myDeskId;

                if (selectedTicket && selectedTicket.id === t.id && !isInProgressByOther) {
                    div.classList.add('selected');
                }

                if (isInProgressByOther) {
                    div.classList.add('in-progress-other');
                } else if (isInProgressMyDesk) {
                    div.classList.add('in-progress-my-desk');
                }

                const statusClass = t.temp_customer_name ? 'linked' : '';
                const statusText = t.temp_customer_name ? `Cliente: ${t.temp_customer_name}` : 'Sem nome';

                const insuranceHtml = t.health_insurance_name ?
                    `<div style="font-size:0.85rem; color:#2196F3; margin-top:5px;">üí≥ ${t.health_insurance_name}</div>` : '';

                // Badge de atendimento por outra mesa
                const attendingBadge = isInProgressByOther
                    ? `<span class="attending-badge">üîí ${t.attending_desk_name || 'Outra mesa'}</span>`
                    : '';

                // Badge de prioridade - Somente este foi solicitado para ser mantido
                const priorityHtml = t.is_priority ?
                    `<div style="font-size:0.85rem; color:#ff9800; font-weight:bold; margin-top:2px;">‚≠ê Preferencial</div>` : '';

                div.innerHTML = `
                    <div class="ticket-code">${t.display_code}${attendingBadge}</div>
                    ${priorityHtml}
                    <div class="ticket-services">${t.services_list || 'Sem servi√ßos'}</div>
                    <span class="ticket-status ${statusClass}">${statusText}</span>
                    ${insuranceHtml}
                `;

                // S√≥ permite clicar se n√£o estiver em atendimento por outra mesa
                if (!isInProgressByOther) {
                    div.onclick = () => selectTicket(t);
                } else {
                    div.onclick = () => showTicketLockedPopup(t.attending_desk_name);
                }

                container.appendChild(div);

            });
        }

        function selectTicket(ticket) {
            selectedTicket = ticket;
            renderTickets(filterTickets(allTickets));
            showTicketDetail(ticket);
        }

        async function showTicketDetail(ticket) {
            const panel = document.getElementById('detail-panel');

            // Obter ID da mesa atual
            const myDeskId = getSelectedDeskId();

            // Verificar se est√° sendo atendido por outra mesa
            // Converter ambos para n√∫mero para garantir compara√ß√£o correta
            const ticketDeskId = ticket.reception_desk_id ? parseInt(ticket.reception_desk_id) : null;
            const isInProgressByOther = (ticket.status === 'IN_RECEPTION' || ticket.status === 'CALLED_RECEPTION')
                && ticketDeskId
                && myDeskId
                && ticketDeskId !== myDeskId;

            // Se estiver sendo atendido por outra mesa, mostrar mensagem de bloqueio
            if (isInProgressByOther) {
                panel.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üîí</div>
                        <h2 style="color: white; margin-bottom: 10px;">Atendimento em Andamento</h2>
                        <p style="color: rgba(255,255,255,0.7); font-size: 1.1rem;">
                            Esta senha est√° sendo atendida em: <strong style="color: #4CAF50;">${ticket.attending_desk_name || 'Outra mesa'}</strong>
                        </p>
                        <p style="color: rgba(255,255,255,0.6); margin-top: 20px;">
                            Voc√™ n√£o pode editar ou interagir com esta senha.
                        </p>
                    </div>
                `;
                return;
            }

            // Fetch detailed services for this ticket
            const res = await fetch(`/api/tickets/${ticket.id}/services`);
            const services = await res.json();

            const hasName = ticket.temp_customer_name;
            const isWaitingReception = ticket.status === 'WAITING_RECEPTION';
            const isCalledReception = ticket.status === 'CALLED_RECEPTION';
            const isInReception = ticket.status === 'IN_RECEPTION';

            // Bot√µes de controle baseados no status
            let actionButtons = '';
            if (isWaitingReception) {
                actionButtons = `
                    <button class="btn btn-large btn-accent" onclick="callToReception(${ticket.id})" style="width:100%; margin-bottom:15px; background: rgba(33, 150, 243, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); color: white; font-weight: 600;">
                        üì¢ CHAMAR PARA RECEP√á√ÉO
                    </button>
                `;
            } else if (isCalledReception) {
                actionButtons = `
                    <button class="btn btn-large" onclick="startAttendance(${ticket.id})" style="width:100%; margin-bottom:15px; background: linear-gradient(135deg, rgba(76, 175, 80, 0.8) 0%, rgba(56, 142, 60, 0.9) 100%); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color:white;">
                        üîî IN√çCIO DO ATENDIMENTO
                    </button>
                `;
            } else if (isInReception) {
                actionButtons = `
                    <button class="btn btn-large" onclick="finishReception(${ticket.id})" style="width:100%; margin-bottom:15px; background: linear-gradient(135deg, rgba(255, 152, 0, 0.8) 0%, rgba(251, 140, 0, 0.9) 100%); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color:white;">
                        ‚úì FINALIZAR E LIBERAR PARA SERVI√áOS
                    </button>
                `;
            }

            const priorityBadge = ticket.is_priority === 1 ?
                `<span class="tag tag-priority">üö® Priorit√°rio</span>` :
                `<span class="tag tag-normal">‚úÖ Normal</span>`;

            const insuranceDisplay = ticket.health_insurance_name ?
                `<span class="tag tag-insurance">üí≥ Conv√™nio</span>` :
                `<span class="tag tag-private">üíµ Particular</span>`;

            panel.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px;">
                    <div>
                        <h2 style="font-size:3rem; color:#fff; margin-bottom:5px;">${ticket.display_code}</h2>
                        <div style="display:flex; gap:10px; align-items:center;">
                            ${priorityBadge}
                            ${insuranceDisplay}
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:1.5rem; font-weight:bold; color:${ticket.status === 'WAITING_RECEPTION' ? '#f1c40f' : '#2ecc71'}">
                            ${getStatusLabel(ticket.status)}
                        </div>
                    </div>
                </div>

                ${actionButtons}

                ${!['WAITING_RECEPTION', 'CALLED_RECEPTION'].includes(ticket.status) ? `
                <div class="customer-link-section" style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                    <h3 style="color: white; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; font-size: 1rem;">
                        <span>Identifica√ß√£o do Cliente</span>
                    </h3>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="customer-name-input"
                            value="${ticket.temp_customer_name || ''}"
                            placeholder="Digite o nome do cliente..."
                            onkeypress="if(event.key === 'Enter') { linkCustomerName(); this.blur(); }"
                            style="flex: 1; padding: 14px 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; font-size: 1rem; background: rgba(255,255,255,0.95); color: #333; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                            onfocus="this.style.borderColor='white'; this.style.background='white';"
                            onblur="this.style.borderColor='rgba(255,255,255,0.3)'; this.style.background='rgba(255,255,255,0.95)'; linkCustomerName();">
                    </div>
                    ${ticket.temp_customer_name ? `
                        <div style="margin-top: 12px; padding: 10px 15px; background: rgba(76, 175, 80, 0.3); backdrop-filter: blur(10px); border: 1px solid rgba(76, 175, 80, 0.5); border-radius: 6px; color: white; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1rem;">‚úì</span>
                            <span style="font-weight: 500;">Cliente identificado</span>
                        </div>
                    ` : `
                        <div style="margin-top: 12px; padding: 10px 15px; background: rgba(255,255,255,0.15); border-radius: 6px; color: rgba(255,255,255,0.9); display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                            <span>‚ö†Ô∏è</span>
                            <span>Insira o nome do cliente para prosseguir</span>
                        </div>
                    `}
                </div>
                ` : ''}

                <div style="margin-bottom: 20px; padding: 12px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 8px; border-left: 4px solid rgba(255,255,255,0.5);">
                    <div style="font-size:0.9rem; color:rgba(255,255,255,0.8); display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.1rem;">üïê</span>
                        <span><strong style="color:white;">Chegada:</strong> ${new Date(ticket.created_at).toLocaleTimeString()}</span>
                    </div>
                </div>

                <div style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px;">
                    <h3 style="margin-top: 0; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; color: white; font-size: 1rem;">
                        <span>Alterar Status</span>
                    </h3>
                    <div style="display: flex; gap: 10px; align-items: stretch;">
                        <select id="status-select" style="flex: 1; padding: 12px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; font-size: 0.95rem; background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
                            <option value="WAITING_RECEPTION" ${ticket.status === 'WAITING_RECEPTION' ? 'selected' : ''}>‚è≥ Aguardando Recep√ß√£o</option>
                            <option value="CALLED_RECEPTION" ${ticket.status === 'CALLED_RECEPTION' ? 'selected' : ''}>üîî Chamado para Recep√ß√£o</option>
                            <option value="IN_RECEPTION" ${ticket.status === 'IN_RECEPTION' ? 'selected' : ''}>üë• Em Atendimento na Recep√ß√£o</option>
                            <option value="WAITING_PROFESSIONAL" ${ticket.status === 'WAITING_PROFESSIONAL' ? 'selected' : ''}>‚è∏Ô∏è Aguardando Profissional</option>
                            <option value="DONE" ${ticket.status === 'DONE' ? 'selected' : ''}>‚úÖ Finalizado</option>
                            <option value="CANCELED" ${ticket.status === 'CANCELED' ? 'selected' : ''}>‚ùå Cancelado</option>
                        </select>
                        <button class="btn" onclick="changeTicketStatus(${ticket.id})" style="padding: 12px 20px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); color: white; white-space: nowrap; font-weight: 500;">
                            Atualizar
                        </button>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85rem; color: rgba(255,255,255,0.7); display: flex; align-items: center; gap: 5px;">
                        <span>Status atual: <strong style="color:white;">${getStatusLabel(ticket.status)}</strong></span>
                    </div>
                </div>

                <div class="services-section" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: white; margin-top: 0; margin-bottom: 15px; font-size: 1rem;">Servi√ßos Solicitados</h3>
                    <div id="services-list" class="services-list"></div>
                </div>
                <div class="add-service-section" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 20px;">
                    <h3 style="color: white; margin-top: 0; margin-bottom: 15px; font-size: 1rem;">Adicionar Servi√ßo</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="add-service-select" style="flex: 1; padding: 12px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; font-size: 0.95rem; background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
                            <option value="">Selecione um servi√ßo...</option>
                        </select>
                        <button class="btn" onclick="addService()" style="padding: 12px 20px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); color: white;">Adicionar</button>
                    </div>
                </div>
            `;

            // Populate add service dropdown
            const select = document.getElementById('add-service-select');
            allServices.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.name;
                select.appendChild(option);
            });

            renderServicesList(services);
        }

        function renderServicesList(services) {
            const container = document.getElementById('services-list');
            if (!container) return;

            container.innerHTML = '';

            if (services.length === 0) {
                container.innerHTML = '<p style="color:rgba(255,255,255,0.6);">Nenhum servi√ßo selecionado</p>';
                return;
            }

            services.forEach((s, index) => {
                const div = document.createElement('div');
                div.className = 'service-item';
                div.innerHTML = `
                    <div class="service-info">
                        <strong>${s.service_name}</strong>
                        <small style="color:#999; margin-left:10px;">(${s.status})</small>
                    </div>
                    <div class="service-actions">
                        <button class="arrow-btn" onclick="moveService(${s.id}, 'up')" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                        <button class="arrow-btn" onclick="moveService(${s.id}, 'down')" ${index === services.length - 1 ? 'disabled' : ''}>‚Üì</button>
                        <button class="btn btn-accent" onclick="removeService(${s.id})">Remover</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }


        async function linkCustomerName() {
            const input = document.getElementById('customer-name-input');
            const name = input.value.trim();

            if (!name) {
                showToast('Digite um nome', 'warning');
                return;
            }

            await fetch(`/api/tickets/${selectedTicket.id}/link`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ customerName: name })
            });

            loadTickets();
        }

        function getStatusLabel(status) {
            const statusLabels = {
                'WAITING_RECEPTION': 'Aguardando Recep√ß√£o',
                'CALLED_RECEPTION': 'Chamado para Recep√ß√£o',
                'IN_RECEPTION': 'Em Atendimento na Recep√ß√£o',
                'WAITING_PROFESSIONAL': 'Aguardando Profissional',
                'DONE': 'Finalizado',
                'CANCELED': 'Cancelado'
            };
            return statusLabels[status] || status;
        }

        async function changeTicketStatus(ticketId) {
            const select = document.getElementById('status-select');
            const newStatus = select.value;

            if (!newStatus) {
                showToast('Selecione um status', 'warning');
                return;
            }

            try {
                const res = await fetch(`/api/tickets/${ticketId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                const data = await res.json();

                if (res.ok) {
                    showToast('‚úÖ Status atualizado com sucesso!', 'success');
                    loadTickets();
                } else {
                    showToast(data.error || 'Erro ao atualizar status', 'error');
                }
            } catch (e) {
                showToast('Erro ao atualizar status', 'error');
                console.error(e);
            }
        }



        async function addService() {
            const select = document.getElementById('add-service-select');
            const serviceId = select.value;

            if (!serviceId) {
                showToast('Selecione um servi√ßo', 'warning');
                return;
            }

            // Check for duplicate services
            const res = await fetch(`/api/tickets/${selectedTicket.id}/services`);
            const existingServices = await res.json();
            const isDuplicate = existingServices.some(s => s.service_id === parseInt(serviceId));

            if (isDuplicate) {
                showToast('Este servi√ßo j√° est√° adicionado a esta senha', 'error');
                return;
            }

            await fetch(`/api/tickets/${selectedTicket.id}/services`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ serviceId: parseInt(serviceId) })
            });

            showToast('Servi√ßo adicionado com sucesso!', 'success');
            loadTickets();
        }

        async function removeService(ticketServiceId) {
            await fetch(`/api/tickets/services/${ticketServiceId}`, {
                method: 'DELETE'
            });

            loadTickets();
        }

        async function moveService(ticketServiceId, direction) {
            await fetch(`/api/tickets/services/${ticketServiceId}/move`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ direction })
            });

            loadTickets();
        }

        // Reception Call/Finish Functions
        let currentReceptionTicket = null;

        async function callToReception(ticketId) {
            const deskId = getSelectedDeskId();

            if (!deskId) {
                showWarningModal('Aten√ß√£o', '<strong>Selecione sua mesa</strong> antes de chamar uma senha!');
                // Highlight desk selector
                const selector = document.querySelector('.desk-selector');
                selector.style.boxShadow = '0 0 0 4px #e74c3c';
                setTimeout(() => selector.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.3)', 2000);
                return;
            }

            try {
                const res = await fetch('/api/reception/call', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticketId, deskId })
                });

                const data = await res.json();

                if (res.ok) {
                    currentReceptionTicket = ticketId;
                    showToast('Senha chamada! Rotacionando na TV.', 'success');
                    loadTickets();
                } else if (res.status === 409) {
                    if (data.error === 'already_in_progress') {
                        // Outra recepcionista j√° est√° atendendo
                        showTicketLockedPopup(data.attendingDesk);
                        loadTickets();
                    } else if (data.error === 'desk_busy') {
                        // Eu j√° tenho ativo ativo - Novo erro do backend
                        showWarningModal('Aten√ß√£o', data.message);
                    } else {
                        showToast(data.error || 'Erro ao chamar senha', 'error');
                    }
                } else {
                    showToast(data.error || 'Erro ao chamar senha', 'error');
                }
            } catch (e) {
                showToast('Erro ao chamar senha', 'error');
            }
        }

        async function startAttendance(ticketId) {
            try {
                const res = await fetch('/api/reception/announce', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticketId })
                });

                if (res.ok) {
                    currentReceptionTicket = ticketId;
                    showToast('Atendimento iniciado! Senha removida da TV.', 'success');
                    await loadTickets();

                    // Auto-focus customer name field
                    setTimeout(() => {
                        const input = document.getElementById('customer-name-input');
                        if (input) input.focus();
                    }, 100);
                } else {
                    showToast('Erro ao iniciar atendimento', 'error');
                }
            } catch (e) {
                showToast('Erro ao iniciar atendimento', 'error');
            }
        }

        async function finishReception(ticketId) {
            // Buscar informa√ß√µes do ticket
            const ticket = allTickets.find(t => t.id === ticketId);

            // Validar nome
            if (!ticket || !ticket.temp_customer_name) {
                showToast('‚ùå √â necess√°rio vincular o nome do cliente antes de finalizar!', 'error');
                return;
            }

            // Validar servi√ßos
            try {
                const servicesRes = await fetch(`/api/tickets/${ticketId}/services`);
                const services = await servicesRes.json();

                if (!services || services.length === 0) {
                    showToast('‚ùå A senha precisa ter pelo menos um servi√ßo selecionado!', 'error');
                    return;
                }

                // Tudo validado, prosseguir com finaliza√ß√£o
                const res = await fetch('/api/reception/finish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticketId })
                });

                if (res.ok) {
                    currentReceptionTicket = null;
                    showToast('Atendimento finalizado com sucesso!', 'success');

                    // Clear details panel
                    selectedTicket = null;
                    document.getElementById('detail-panel').innerHTML = '<div class="empty-state"><i class="fas fa-ticket-alt" style="font-size: 3rem; margin-bottom: 20px;"></i><p>Selecione uma senha para visualizar</p></div>';

                    loadTickets();
                } else {
                    const data = await res.json();
                    showToast(data.error || 'Erro ao finalizar', 'error');
                }
            } catch (e) {
                showToast('Erro ao finalizar', 'error');
                console.error(e);
            }
        }



        // Initial load (loadDesks is called in checkAuth after header is rendered)
        loadServices();
        loadTickets();

        // Real-time updates
        socket.on('new_ticket', () => loadTickets());
        socket.on('ticket_updated', () => loadTickets());
        socket.on('call_ticket', () => loadTickets());
    </script>
    <script src="js/common/trace.js"></script>
    <script src="js/common/toast.js"></script>
    <div id="locked-ticket-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-icon">üîí</span>
            <h3 class="modal-title">Atendimento em Andamento</h3>
            <p class="modal-message" id="locked-modal-message">Esta senha j√° est√° sendo atendida.</p>
            <button class="btn btn-large" onclick="closeLockedModal()" style="width: 100%;">Entendido</button>
        </div>
    </div>

    <script>
        function showTicketLockedPopup(deskName) {
            const modal = document.getElementById('locked-ticket-modal');
            const message = document.getElementById('locked-modal-message');
            message.innerHTML = `Esta senha est√° sendo atendida por<br><strong>${deskName || 'Outra mesa'}</strong>`;
            modal.style.display = 'flex';
        }

        function closeLockedModal() {
            document.getElementById('locked-ticket-modal').style.display = 'none';
        }

        // Fechar modal ao clicar fora
        document.getElementById('locked-ticket-modal').addEventListener('click', (e) => {
            if (e.target.id === 'locked-ticket-modal') {
                closeLockedModal();
            }
        });
    </script>
    <div id="warning-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-icon" style="color: #f1c40f;">‚ö†Ô∏è</span>
            <h3 class="modal-title" id="warning-modal-title">Aviso</h3>
            <p class="modal-message" id="warning-modal-message">Mensagem de aviso.</p>
            <button class="btn btn-large" onclick="closeWarningModal()" style="width: 100%;">OK</button>
        </div>
    </div>

    <script>
        function showWarningModal(title, message) {
            document.getElementById('warning-modal-title').innerText = title;
            document.getElementById('warning-modal-message').innerHTML = message;
            document.getElementById('warning-modal').style.display = 'flex';
        }

        function closeWarningModal() {
            document.getElementById('warning-modal').style.display = 'none';
        }

        // Fechar modal ao clicar fora
        document.getElementById('warning-modal').addEventListener('click', (e) => {
            if (e.target.id === 'warning-modal') {
                closeWarningModal();
            }
        });
    </script>
    <script src="global-ui.js"></script>
</body>

</html>