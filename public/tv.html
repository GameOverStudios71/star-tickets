<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Tickets - Painel</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
    <div class="tv-container">
        <div class="tv-main">
            <div class="customer-display" id="main-customer">Aguardando chamada...</div>
            <div class="ticket-display" id="main-ticket">---</div>
            <div class="room-display" id="main-room">---</div>
        </div>
        <div class="tv-sidebar">
            <h2>Hist√≥rico</h2>
            <div id="history-list">
                <!-- History items -->
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const historyList = document.getElementById('history-list');

        let calledTickets = []; // Array of tickets that have been called
        let currentIndex = 0;
        let rotationInterval = null;

        // Audio context for "ding dong"
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playAlert() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.type = 'sine';
            osc.frequency.setValueAtTime(660, audioCtx.currentTime);
            osc.frequency.setValueAtTime(440, audioCtx.currentTime + 0.5);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1);

            osc.start();
            osc.stop(audioCtx.currentTime + 1);
        }

        // Fetch all called tickets from backend
        async function loadCalledTickets() {
            try {
                // Check if TV has a configured establishment
                const configuredEst = localStorage.getItem('star_tickets_tv_establishment');
                const params = configuredEst ? `?establishment_id=${configuredEst}` : '';

                const res = await fetch(`/api/called-tickets${params}`);
                calledTickets = await res.json();

                if (calledTickets.length === 0) {
                    // No tickets called, show waiting message
                    document.getElementById('main-customer').innerText = 'Aguardando chamada...';
                    document.getElementById('main-ticket').innerText = '---';
                    document.getElementById('main-room').innerText = '---';
                    stopRotation();
                } else if (calledTickets.length === 1) {
                    // Only one ticket, display it statically
                    displayTicket(calledTickets[0]);
                    stopRotation();
                } else {
                    // Multiple tickets, start rotation
                    startRotation();
                }
            } catch (e) {
                console.error('Error loading called tickets:', e);
            }
        }

        function displayTicket(ticket) {
            if (!ticket) return;

            document.getElementById('main-ticket').innerText = ticket.display_code;
            document.getElementById('main-customer').innerText = ticket.temp_customer_name || 'Cliente';
            document.getElementById('main-room').innerText = ticket.room_name || '---';
        }

        function startRotation() {
            // Stop any existing rotation
            stopRotation();

            // Display first ticket immediately
            currentIndex = 0;
            displayTicket(calledTickets[currentIndex]);

            // Start rotation every 5 seconds
            rotationInterval = setInterval(() => {
                currentIndex = (currentIndex + 1) % calledTickets.length;
                displayTicket(calledTickets[currentIndex]);
            }, 5000);
        }

        function stopRotation() {
            if (rotationInterval) {
                clearInterval(rotationInterval);
                rotationInterval = null;
            }
        }

        // WebSocket: When a new ticket is called
        socket.on('call_ticket', (data) => {
            playAlert();

            // Reload the called tickets list
            loadCalledTickets();
        });

        // WebSocket: When a ticket is updated (e.g., service started)
        socket.on('ticket_updated', () => {
            loadCalledTickets();
        });

        function addToHistory(item) {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `<strong>${item.displayCode}</strong> - ${item.roomName}`;
            historyList.prepend(div);

            if (historyList.children.length > 5) {
                historyList.removeChild(historyList.lastChild);
            }
        }

        // Initial load
        loadCalledTickets();

        // Refresh every 10 seconds as backup
        setInterval(loadCalledTickets, 10000);
    </script>
    }
    </script>
    <script src="js/common/trace.js"></script>
    <script src="js/common/toast.js"></script>
</body>

</html>