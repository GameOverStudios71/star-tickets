<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Tickets - Painel</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="auth-helper.js"></script>
    <style>
        /* Split Screen Layout */
        .tv-split-container {
            display: flex;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .tv-split-left {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .tv-split-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: transparent;
        }

        /* YouTube section - top 60% */
        .tv-youtube-section {
            flex: 6;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tv-youtube-section iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* History section - bottom 40% with acrylic effect */
        .tv-history-section {
            flex: 4;
            background: rgba(var(--acrylic-base-color), 0.1);
            backdrop-filter: blur(var(--acrylic-blur));
            -webkit-backdrop-filter: blur(var(--acrylic-blur));
            border-top: 1px solid rgba(var(--acrylic-base-color), 0.2);
            padding: 15px 20px;
            overflow: hidden;
        }

        .tv-history-title {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 500;
        }

        .tv-history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: hidden;
        }

        .tv-history-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 15px;
            background: rgba(var(--acrylic-base-color), 0.1);
            backdrop-filter: blur(var(--acrylic-blur));
            -webkit-backdrop-filter: blur(var(--acrylic-blur));
            border: 1px solid rgba(var(--acrylic-base-color), 0.2);
            border-radius: 8px;
            border-left: 4px solid var(--color-accent, #e74c3c);
        }

        .tv-history-item .ticket-code {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--color-accent, #e74c3c);
            min-width: 80px;
        }

        .tv-history-item .customer-name {
            flex: 1;
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tv-history-item .room-name {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: right;
        }

        #tv-est-name {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 300;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        /* Override tv-container for split layout */
        .tv-split-left .tv-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tv-split-left .tv-main {
            width: 100%;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body class="has-background">
    <script src="global-ui.js"></script>

    <div class="tv-split-container">
        <!-- Left Side: Ticket Display -->
        <div class="tv-split-left">
            <div class="tv-container" style="width: 100%; height: 100%;">
                <div class="tv-main" style="width: 100%; max-width: 100%; flex: 1; position: relative;">
                    <div id="tv-est-name">Star Tickets</div>
                    <div class="customer-display" id="main-customer">Aguardando chamada...</div>
                    <div class="ticket-display" id="main-ticket">---</div>
                    <div class="room-display" id="main-room">---</div>
                </div>
            </div>
        </div>

        <!-- Right Side: YouTube + History -->
        <div class="tv-split-right">
            <!-- YouTube Video - Top -->
            <div class="tv-youtube-section">
                <iframe src="https://www.youtube.com/embed/L4u7_B7ErwE?autoplay=1&mute=1&loop=1&playlist=L4u7_B7ErwE"
                    title="YouTube video"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
                </iframe>
            </div>

            <!-- History - Bottom -->
            <div class="tv-history-section">
                <div class="tv-history-title">Últimas Chamadas</div>
                <div class="tv-history-list" id="history-list">
                    <!-- History items will be inserted here by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();


        let calledTickets = []; // Array of tickets that have been called (from backend)
        let callHistory = []; // Local history of ALL calls (frontend only, persists)
        let currentIndex = 0;
        let rotationInterval = null;

        // Audio context for alerts
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // Sound Presets
        const soundPresets = {
            'ding-dong': () => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(660, audioCtx.currentTime);
                osc.frequency.setValueAtTime(440, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.8);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.8);
            },
            'triple-beep': () => {
                for (let i = 0; i < 3; i++) {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(880, audioCtx.currentTime + i * 0.2);
                    gain.gain.setValueAtTime(0.3, audioCtx.currentTime + i * 0.2);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.2 + 0.15);
                    osc.start(audioCtx.currentTime + i * 0.2);
                    osc.stop(audioCtx.currentTime + i * 0.2 + 0.15);
                }
            },
            'chime': () => {
                const notes = [523, 659, 784, 1047]; // C5, E5, G5, C6
                notes.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime + i * 0.15);
                    gain.gain.setValueAtTime(0.4, audioCtx.currentTime + i * 0.15);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.15 + 0.4);
                    osc.start(audioCtx.currentTime + i * 0.15);
                    osc.stop(audioCtx.currentTime + i * 0.15 + 0.4);
                });
            },
            'bell': () => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 1.5);
                gain.gain.setValueAtTime(0.6, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.5);
                osc.start();
                osc.stop(audioCtx.currentTime + 1.5);
            },
            'fanfare': () => {
                const notes = [392, 523, 659, 784]; // G4, C5, E5, G5
                notes.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime + i * 0.2);
                    gain.gain.setValueAtTime(0.25, audioCtx.currentTime + i * 0.2);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.2 + 0.3);
                    osc.start(audioCtx.currentTime + i * 0.2);
                    osc.stop(audioCtx.currentTime + i * 0.2 + 0.3);
                });
            },
            'hospital': () => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(440, audioCtx.currentTime);
                osc.frequency.setValueAtTime(550, audioCtx.currentTime + 0.4);
                osc.frequency.setValueAtTime(440, audioCtx.currentTime + 0.8);
                gain.gain.setValueAtTime(0.4, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.2);
                osc.start();
                osc.stop(audioCtx.currentTime + 1.2);
            },
            'silent': () => {
                // No sound
            }
        };

        function playAlert() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const preset = localStorage.getItem('star_tickets_tv_sound') || 'ding-dong';
            if (soundPresets[preset]) {
                soundPresets[preset]();
            }
        }

        // Listen for sound preset changes via WebSocket
        socket.on('tv_sound_changed', (data) => {
            localStorage.setItem('star_tickets_tv_sound', data.preset);
            playAlert(); // Play sample of new sound
        });

        // Establishment ID do usuário logado (será preenchido após checkAuth)
        let userEstablishmentId = null;

        // Render history list from local callHistory (most recent first, no scroll)
        function renderHistory() {
            const historyList = document.getElementById('history-list');
            if (!historyList) return;

            // Calculate how many items fit based on container height
            // Each item is roughly 50px, so we show max 5 items
            const maxItems = 5;

            // callHistory is already most recent first
            const displayItems = callHistory.slice(0, maxItems);

            historyList.innerHTML = displayItems.map(ticket => `
                <div class="tv-history-item">
                    <span class="ticket-code">${ticket.display_code}</span>
                    <span class="customer-name">${ticket.temp_customer_name || 'Cliente'}</span>
                    <span class="room-name">${ticket.room_name || '---'}</span>
                </div>
            `).join('');
        }

        // Add a ticket to local history (called when WebSocket receives a call)
        function addToHistory(ticket) {
            // Add to beginning of history (most recent first)
            callHistory.unshift({
                display_code: ticket.display_code || ticket.displayCode,
                temp_customer_name: ticket.temp_customer_name || ticket.customerName || 'Cliente',
                room_name: ticket.room_name || ticket.roomName || '---',
                called_at: new Date()
            });

            // Keep only last 20 items in memory
            if (callHistory.length > 20) {
                callHistory = callHistory.slice(0, 20);
            }

            // Re-render
            renderHistory();
        }

        // Fetch all called tickets from backend (for main display rotation only)
        async function loadCalledTickets() {
            try {
                // Usar establishment do usuário logado
                const params = userEstablishmentId ? `?establishment_id=${userEstablishmentId}` : '';

                const res = await fetch(`/api/called-tickets${params}`);
                calledTickets = await res.json();

                if (calledTickets.length === 0) {
                    // No tickets called, show waiting message
                    document.getElementById('main-customer').innerText = 'Aguardando chamada...';
                    document.getElementById('main-ticket').innerText = '---';
                    document.getElementById('main-room').innerText = '---';
                    stopRotation();
                } else if (calledTickets.length === 1) {
                    // Only one ticket, display it statically
                    displayTicket(calledTickets[0]);
                    stopRotation();
                } else {
                    // Multiple tickets, start rotation
                    startRotation();
                }
            } catch (e) {
                console.error('Error loading called tickets:', e);
            }
        }

        let lastDisplayedCode = null; // Rastrear último ticket exibido

        // Text-to-Speech function
        function speakTicketCall(ticket) {
            const ttsEnabled = localStorage.getItem('star_tickets_tv_tts') === 'true';
            if (!ttsEnabled || !('speechSynthesis' in window)) return;

            // Build the speech text
            let text;
            if (ticket.temp_customer_name && ticket.temp_customer_name !== 'Cliente') {
                text = `${ticket.temp_customer_name}, dirija-se à ${ticket.room_name}`;
            } else {
                text = `Senha ${ticket.display_code}, dirija-se à ${ticket.room_name}`;
            }

            // Cancel any ongoing speech
            speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-BR';
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 1;

            // Try to find a Portuguese voice
            const voices = speechSynthesis.getVoices();
            const ptVoice = voices.find(v => v.lang.startsWith('pt')) || voices[0];
            if (ptVoice) utterance.voice = ptVoice;

            speechSynthesis.speak(utterance);
        }

        // Listen for TTS toggle via WebSocket
        socket.on('tv_tts_changed', (data) => {
            localStorage.setItem('star_tickets_tv_tts', data.enabled ? 'true' : 'false');
        });

        function displayTicket(ticket, silent = false) {
            if (!ticket) return;

            // Tocar som e falar se o ticket mudou
            if (!silent && lastDisplayedCode !== ticket.display_code) {
                playAlert();
                // Delay speech slightly to let alert sound finish
                setTimeout(() => speakTicketCall(ticket), 800);
            }
            lastDisplayedCode = ticket.display_code;

            document.getElementById('main-ticket').innerText = ticket.display_code;
            document.getElementById('main-customer').innerText = ticket.temp_customer_name || 'Cliente';
            document.getElementById('main-room').innerText = ticket.room_name || '---';
        }

        function startRotation() {
            // Stop any existing rotation
            stopRotation();

            // Display first ticket immediately
            currentIndex = 0;
            displayTicket(calledTickets[currentIndex]);

            // Start rotation every 5 seconds
            rotationInterval = setInterval(() => {
                currentIndex = (currentIndex + 1) % calledTickets.length;
                displayTicket(calledTickets[currentIndex]);
            }, 5000);
        }

        function stopRotation() {
            if (rotationInterval) {
                clearInterval(rotationInterval);
                rotationInterval = null;
            }
        }

        // WebSocket: When a new ticket is called
        socket.on('call_ticket', (data) => {
            // Verificar se a TV deve reagir a este estabelecimento
            const configuredEst = localStorage.getItem('star_tickets_tv_establishment');
            if (configuredEst && data.establishmentId && parseInt(configuredEst) !== data.establishmentId) {
                // Ticket de outro estabelecimento, ignorar
                return;
            }

            playAlert();

            // Add to local history (persist even when ticket goes to service)
            addToHistory(data);

            // Reload the called tickets list (for main display rotation)
            loadCalledTickets();
        });

        // WebSocket: When a ticket is updated (e.g., service started)
        socket.on('ticket_updated', () => {
            loadCalledTickets();
        });



        // Verificar autenticação e obter establishment
        checkAuth().then(user => {
            if (!user) return;
            userEstablishmentId = user.establishment_id;

            // Set Establishment Name
            if (user.establishment_name) {
                document.getElementById('tv-est-name').innerText = user.establishment_name;
            }

            // Initial load after authentication
            loadCalledTickets();
        });

        // Refresh every 10 seconds as backup
        setInterval(loadCalledTickets, 10000);
    </script>
    <script src="js/common/trace.js"></script>
    <script src="js/common/toast.js"></script>
</body>

</html>