version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: st_postgres
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

  evolution:
    build:
      context: .
      dockerfile: Dockerfile.evolution
    container_name: st_evolution
    restart: always
    depends_on:
      - postgres
    ports:
      - "8080:8080"
    environment:
      # Evolution Config
      SERVER_PORT: 8080
      SERVER_URL: http://localhost:8080
      DATABASE_PROVIDER: postgresql
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/evolution_db?schema=public
      AUTHENTICATION_API_KEY: 429683C4C977415CAAFCCE10F7D57E11
      # Local cache (Redis optional, using local for simplicity)
      CACHE_LOCAL_ENABLED: "true"
      CACHE_REDIS_ENABLED: "false"

  startickets:
    build:
      context: .
      dockerfile: Dockerfile.startickets
    container_name: st_app
    restart: always
    depends_on:
      - postgres
      - evolution
    ports:
      - "4000:4000"
    environment:
      MIX_ENV: dev
      # Database connection
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      DB_HOST: postgres
      DB_DATABASE: star_tickets_dev
      # Evolution Integration
      EVOLUTION_API_URL: http://evolution:8080
      EVOLUTION_API_KEY: 429683C4C977415CAAFCCE10F7D57E11
      EVOLUTION_INSTANCE_NAME: StarTickets
      # Phoenix Config
      # SECRET_KEY_BASE should be set securely in prod, strict dev default here
      SECRET_KEY_BASE: k3XbRBA8tEWckLA8mqaAtwCe2rcdTHqbn3qc/6Y8Vus3FEI2dnUWgUIF/NPfJX+y
      PHX_HOST: localhost

volumes:
  postgres_data:
